# Collected project modules
# Root: /Users/ekaterina/Documents/GitHub/api-requests-open-msr
# Files: 38


====================================================================================================
MODULE: checks.patient_checks
PATH:   checks/patient_checks.py
====================================================================================================

def assert_valid_patient_response(patient: dict) -> None:
    # --- patient ---
    assert isinstance(patient, dict)
    assert "uuid" in patient and isinstance(patient["uuid"], str)
    assert patient.get("voided") is False

    # --- person ---
    person = patient.get("person")
    assert isinstance(person, dict)

    assert "uuid" in person
    assert person["uuid"] == patient["uuid"]

    assert person.get("gender") in {"M", "F", "O", "U"}
    assert "birthdate" in person
    assert isinstance(person["birthdate"], str)

    preferred_name = person.get("preferredName")
    assert isinstance(preferred_name, dict)
    assert isinstance(preferred_name.get("display"), str)
    assert preferred_name["display"].strip() != ""

    # --- identifiers ---
    identifiers = patient.get("identifiers")
    assert isinstance(identifiers, list)
    assert len(identifiers) > 0

    openmrs_ids = [
        i for i in identifiers
        if "OpenMRS ID" in i.get("display", "")
    ]
    assert len(openmrs_ids) >= 1

    for identifier in openmrs_ids:
        assert "uuid" in identifier
        assert isinstance(identifier["uuid"], str)
        assert "display" in identifier
        assert isinstance(identifier["display"], str)


====================================================================================================
MODULE: checks.visit_checks
PATH:   checks/visit_checks.py
====================================================================================================

# checks/visit_checks.py

def assert_valid_visit_response(visit: dict, *, patient_uuid: str, visit_type_uuid: str, location_uuid: str) -> None:
    assert isinstance(visit, dict)
    assert isinstance(visit.get("uuid"), str) and visit["uuid"]

    # common flags
    assert visit.get("voided") in (False, None)  # –æ–±—ã—á–Ω–æ False, –Ω–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç representation

    # patient
    patient = visit.get("patient")
    if isinstance(patient, dict):
        assert patient.get("uuid") == patient_uuid
    else:
        # –∏–Ω–æ–≥–¥–∞ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫–æ–π UUID –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç v=...
        assert patient == patient_uuid

    # visitType
    vt = visit.get("visitType")
    if isinstance(vt, dict):
        assert vt.get("uuid") == visit_type_uuid
    else:
        assert vt == visit_type_uuid

    # startDatetime
    assert isinstance(visit.get("startDatetime"), str)
    assert visit["startDatetime"].strip() != ""

    # location (–≤ –ø—Ä–∏–º–µ—Ä–µ payload –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç; —á–∞—â–µ –≤—Å–µ–≥–æ –æ–∂–∏–¥–∞–µ—Ç—Å—è –≤ –æ—Ç–≤–µ—Ç–µ)
    loc = visit.get("location")
    if loc is not None:
        if isinstance(loc, dict):
            assert loc.get("uuid") == location_uuid
        else:
            assert loc == location_uuid


====================================================================================================
MODULE: request_modules.create_random_valid_person
PATH:   request_modules/create_random_valid_person.py
====================================================================================================

import random
import uuid
import requests
from requests.auth import HTTPBasicAuth
from faker import Faker

from src.openmrs_patient import Person, Address, PersonName

fake = Faker("ru_RU")

BASE_URL = "http://localhost/openmrs/ws/rest/v1"
USERNAME = "admin"
PASSWORD = "Admin123"


def _fetch_person_full(person_uuid: str) -> dict:
    url = f"{BASE_URL}/person/{person_uuid}"
    r = requests.get(
        url,
        params={"v": "full"},
        auth=HTTPBasicAuth(USERNAME, PASSWORD),
        headers={"Accept": "application/json"},
        timeout=30,
    )
    r.raise_for_status()
    return r.json()


def person_from_json(data: dict) -> Person:
    def parse_names(obj: dict) -> list[PersonName]:
        names_local: list[PersonName] = []

        preferred = obj.get("preferredName")
        if isinstance(preferred, dict) and preferred.get("givenName") and preferred.get("familyName"):
            names_local.append(PersonName(givenName=preferred["givenName"], familyName=preferred["familyName"]))

        for n in obj.get("names", []) or []:
            if isinstance(n, dict) and n.get("givenName") and n.get("familyName"):
                if not any(x.givenName == n["givenName"] and x.familyName == n["familyName"] for x in names_local):
                    names_local.append(PersonName(givenName=n["givenName"], familyName=n["familyName"]))

        return names_local

    names = parse_names(data)

    if not names:
        person_uuid = data.get("uuid")
        if person_uuid:
            full_data = _fetch_person_full(person_uuid)
            names = parse_names(full_data)
            data = full_data

    if not names:
        raise ValueError(
            "OpenMRS returned Person without parseable names. "
            f"uuid={data.get('uuid')}, keys={list(data.keys())}"
        )

    raw_addresses = data.get("addresses") or []
    addresses: list[Address] = [
        Address(address1=a.get("address1", ""), cityVillage=a.get("cityVillage", ""))
        for a in raw_addresses
        if isinstance(a, dict)
    ]

    return Person(
        names=names,
        gender=data.get("gender", ""),
        birthdate=data.get("birthdate", ""),
        addresses=addresses,
    )


def generate_person_payload() -> dict:
    gender = random.choice(["M", "F"])
    return {
        "names": [
            {
                "givenName": fake.first_name_male() if gender == "M" else fake.first_name_female(),
                "familyName": fake.last_name(),
                "preferred": True,
            }
        ],
        "gender": gender,
        "birthdate": fake.date_of_birth(minimum_age=18, maximum_age=80).isoformat(),
    }


def create_valid_person() -> Person:
    url = f"{BASE_URL}/person"
    payload = generate_person_payload()

    response = requests.post(
        url,
        json=payload,
        auth=HTTPBasicAuth(USERNAME, PASSWORD),
        headers={"Accept": "application/json", "Content-Type": "application/json"},
        timeout=30,
    )

    print("Payload:", payload)
    print("Status:", response.status_code)
    print("Response:", response.text)

    response.raise_for_status()
    return person_from_json(response.json())


# =======================
# ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û –ü–û –û–®–ò–ë–ö–ï MissingRequiredIdentifierException
# =======================

def get_required_identifier_type_uuid(required_name: str = "OpenMRS ID") -> str:
    """
    –ù–∞—Ö–æ–¥–∏—Ç UUID –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ identifier type (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é OpenMRS ID).
    """
    url = f"{BASE_URL}/patientidentifiertype"
    r = requests.get(
        url,
        params={"v": "default"},
        auth=HTTPBasicAuth(USERNAME, PASSWORD),
        headers={"Accept": "application/json"},
        timeout=30,
    )
    r.raise_for_status()

    for item in r.json().get("results", []):
        if item.get("required") is True and item.get("name") == required_name:
            return item["uuid"]

    raise RuntimeError(f"Required identifier type '{required_name}' not found")


def generate_required_identifier_value() -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è required –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞.
    (–ï—Å–ª–∏ –≤ —Å–∏—Å—Ç–µ–º–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å—Ç—Ä–æ–≥–∏–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è OpenMRS ID ‚Äî –ø–æ–¥—Å—Ç—Ä–æ–∏–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é.)
    """
    # —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤: —É–Ω–∏–∫–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
    return str(uuid.uuid4())


def get_required_openmrs_id() -> tuple[str, str]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (openmrs_id_type_uuid, generated_openmrs_id_value)
    """
    id_type_uuid = get_required_identifier_type_uuid("OpenMRS ID")
    value = generate_required_identifier_value()
    return id_type_uuid, value


====================================================================================================
MODULE: request_modules.create_valid_patient_with_person
PATH:   request_modules/create_valid_patient_with_person.py
====================================================================================================


import requests
from requests.auth import HTTPBasicAuth

from src.openmrs_patient import PatientPayload, Person, PersonName, Address, Identifier




def create_valid_patient_with_person(username:str, password: str, person: Person, location: str, identifier_type: str, patient_identifier: str):
    # --- config ---
    BASE_URL = "http://localhost/openmrs/ws/rest/v1"



    patient_identifier = patient_identifier


    payload = PatientPayload(
        person=person,
        identifiers=[
            Identifier(
                identifier=patient_identifier,
                identifierType=identifier_type,
                location=location,
            )
        ],
    )


    headers = {
        "Content-Type": "application/json",
        "Accept": "application/json",
    }


    auth = HTTPBasicAuth(username, password)


    resp = requests.post(
        f"{BASE_URL}/patient",
        headers=headers,
        json=payload.to_dict(),
        auth=auth,
    )

    assert resp.status_code == 201


    return resp.json()


def create_in_valid_patient_with_person(username:str, password: str, person: Person, location: str, identifier_type: str, patient_identifier: str):
    # --- config ---
    BASE_URL = "http://localhost/openmrs/ws/rest/v1"



    patient_identifier = patient_identifier


    payload = PatientPayload(
        person=person,
        identifiers=[
            Identifier(
                identifier=patient_identifier,
                identifierType=identifier_type,
                location=location,
            )
        ],
    )


    headers = {
        "Content-Type": "application/json",
        "Accept": "application/json",
    }


    auth = HTTPBasicAuth(username, password)


    resp = requests.post(
        f"{BASE_URL}/patient",
        headers=headers,
        json=payload.to_dict(),
        auth=auth,
    )

    assert resp.status_code == 400


    return resp


====================================================================================================
MODULE: request_modules.find_patient.find_patient
PATH:   request_modules/find_patient/find_patient.py
====================================================================================================

import requests
from requests.auth import HTTPBasicAuth
from typing import Optional

BASE_URL = "http://localhost/openmrs/ws/rest/v1"
USERNAME = "admin"
PASSWORD = "Admin123"


def find_patient_by_identifier(identifier: str) -> Optional[dict]:
    """
    –ò—â–µ—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞ –ø–æ identifier.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç patient object (dict) –∏–ª–∏ None.
    """
    url = f"{BASE_URL}/patient"

    response = requests.get(
        url,
        params={
            "q": identifier,
            "v": "default",
        },
        auth=HTTPBasicAuth(USERNAME, PASSWORD),
        headers={"Accept": "application/json"},
        timeout=30,
    )

    response.raise_for_status()
    data = response.json()

    results = data.get("results", [])
    if not results:
        return None

    # –æ–±—ã—á–Ω–æ identifier —É–Ω–∏–∫–∞–ª–µ–Ω ‚Üí –±–µ—Ä—ë–º –ø–µ—Ä–≤–æ–≥–æ
    return results[0]


====================================================================================================
MODULE: request_modules.locations.get_all_locations
PATH:   request_modules/locations/get_all_locations.py
====================================================================================================

import requests
from requests.auth import HTTPBasicAuth

# ==== –ù–ê–°–¢–†–û–ô–ö–ò ====
BASE_URL = "http://localhost/openmrs/ws/rest/v1"
USERNAME = "admin"
PASSWORD = "Admin123"

URL = f"{BASE_URL}/location"

# ==== –ó–ê–ü–†–û–° ====
response = requests.get(
    URL,
    auth=HTTPBasicAuth(USERNAME, PASSWORD),
    headers={"Accept": "application/json"}
)

response.raise_for_status()
data = response.json()

# ==== –í–´–í–û–î ====
print("\nüìç –°–ø–∏—Å–æ–∫ –ª–æ–∫–∞—Ü–∏–π OpenMRS\n" + "=" * 40)

for idx, loc in enumerate(data.get("results", []), start=1):
    name = loc.get("name", "‚Äî")
    print(f"\n{idx}. {name}")
    print("-" * (len(name) + 4))
    print(f"UUID       : {loc.get('uuid')}")
    print(f"–û–ø–∏—Å–∞–Ω–∏–µ  : {loc.get('description') or '‚Äî'}")
    print(f"Retired   : {loc.get('retired')}")

print("\n‚úÖ –ì–æ—Ç–æ–≤–æ")


====================================================================================================
MODULE: request_modules.locations.get_random_valid_location
PATH:   request_modules/locations/get_random_valid_location.py
====================================================================================================

import requests
from requests.auth import HTTPBasicAuth
import random



def get_random_valid_location():
    BASE_URL = "http://localhost/openmrs/ws/rest/v1"
    USERNAME = "admin"
    PASSWORD = "Admin123"

    url = f"{BASE_URL}/location"

    response = requests.get(
        url,
        auth=HTTPBasicAuth(USERNAME, PASSWORD),
        headers={"Accept": "application/json"},
        timeout=30,
    )

    locations = response.json().get("results", [])

    if not locations:
        raise RuntimeError("–°–ø–∏—Å–æ–∫ –ª–æ–∫–∞—Ü–∏–π –ø—É—Å—Ç")

    return random.choice(locations)


====================================================================================================
MODULE: request_modules.locations.make_location_retiered
PATH:   request_modules/locations/make_location_retiered.py
====================================================================================================

import requests
from requests.auth import HTTPBasicAuth

# ==== –ù–ê–°–¢–†–û–ô–ö–ò ====
BASE_URL = "http://localhost/openmrs/ws/rest/v1"
USERNAME = "admin"
PASSWORD = "Admin123"

LOCATION_UUID = "6d49188b-2bdf-4c6e-bdff-7eeed3e15a64"
REASON = "Location is no longer in use"

URL = f"{BASE_URL}/location/{LOCATION_UUID}"

# ==== –ó–ê–ü–†–û–° ====
response = requests.delete(
    URL,
    auth=HTTPBasicAuth(USERNAME, PASSWORD),
    headers={"Accept": "application/json"},
    params={"reason": REASON}
)

response.raise_for_status()

print(f"‚úÖ Location {LOCATION_UUID} –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ retired")


====================================================================================================
MODULE: request_modules.patientidentifiertype.get_all_patientidentifiertype
PATH:   request_modules/patientidentifiertype/get_all_patientidentifiertype.py
====================================================================================================

import requests
from requests.auth import HTTPBasicAuth

BASE_URL = "http://localhost/openmrs/ws/rest/v1"
USERNAME = "admin"
PASSWORD = "Admin123"  # –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π –ø–∞—Ä–æ–ª—å

url = f"{BASE_URL}/patientidentifiertype"

response = requests.get(
    url,
    params={"v": "default"},
    auth=HTTPBasicAuth(USERNAME, PASSWORD),
    headers={"Accept": "application/json"}
)

response.raise_for_status()

data = response.json()

for item in data.get("results", []):
    print(f"Name: {item['name']}")
    print(f"UUID: {item['uuid']}")
    print(f"Required: {item.get('required')}")
    print(f"Format: {item.get('format')}")
    print("-" * 40)


====================================================================================================
MODULE: request_modules.patientidentifiertype.get_random_valid_patient_identifier_type
PATH:   request_modules/patientidentifiertype/get_random_valid_patient_identifier_type.py
====================================================================================================

import random
import string
import re
import requests
from requests.auth import HTTPBasicAuth
from typing import Optional, Tuple

BASE_URL = "http://localhost/openmrs/ws/rest/v1"
USERNAME = "admin"
PASSWORD = "Admin123"


def generate_identifier_from_format(fmt: str) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç identifier_value –¥–ª—è –∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
    ^[A-Z]{1}-[0-9]{7}$
    """
    if fmt == "^[A-Z]{1}-[0-9]{7}$":
        letter = random.choice(string.ascii_uppercase)
        digits = "".join(random.choices(string.digits, k=7))
        return f"{letter}-{digits}"

    raise ValueError(f"Unsupported identifier format: {fmt}")


def get_identifier_type_with_generated_value() -> Optional[Tuple[str, str]]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (identifier_type_uuid, generated_identifier_value)
    """
    url = f"{BASE_URL}/patientidentifiertype"

    response = requests.get(
        url,
        params={"v": "default"},
        auth=HTTPBasicAuth(USERNAME, PASSWORD),
        headers={"Accept": "application/json"}
    )
    response.raise_for_status()

    data = response.json()

    for item in data.get("results", []):
        fmt = item.get("format")
        if not fmt:
            continue

        identifier_value = generate_identifier_from_format(fmt)

        # —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
        if re.fullmatch(fmt, identifier_value):
            return item["uuid"], identifier_value

    return None

def generate_random_openmrs_identifier(length: int = 8) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ—Å—Ç–æ–π –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π OpenMRS identifier
    (—Ü–∏—Ñ—Ä—ã, –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ Luhn)
    """
    return "".join(random.choices(string.digits, k=length))



MOD30_ALPHABET = "0123456789ACDEFGHJKLMNPRTUVWXY"
MOD30_MAP = {c: i for i, c in enumerate(MOD30_ALPHABET)}

def _luhn_mod30_sum(chars: str, *, start_double: bool) -> int:
    total = 0
    double = start_double
    for ch in reversed(chars):
        if ch not in MOD30_MAP:
            raise ValueError(f"Unallowed character '{ch}' for OpenMRS Mod30")
        v = MOD30_MAP[ch]
        if double:
            v *= 2
            # "—Å—É–º–º–∞ —Ü–∏—Ñ—Ä" –≤ –±–∞–∑–µ 30
            v = (v // 30) + (v % 30)
        total += v
        double = not double
    return total

def luhn_mod30_check_char(payload: str) -> str:
    # –í–ê–ñ–ù–û: –¥–ª—è payload –Ω–∞—á–∏–Ω–∞–µ–º —Å —É–¥–≤–æ–µ–Ω–∏—è —Å–ø—Ä–∞–≤–∞,
    # –ø–æ—Ç–æ–º—É —á—Ç–æ –≤ –ø–æ–ª–Ω–æ–º ID —Å–ø—Ä–∞–≤–∞ –±—É–¥–µ—Ç check digit (–Ω–µ —É–¥–≤–∞–∏–≤–∞–µ—Ç—Å—è),
    # –∞ –±–ª–∏–∂–∞–π—à–∏–π —Å–ª–µ–≤–∞ —Å–∏–º–≤–æ–ª (–ø—Ä–∞–≤—ã–π —Å–∏–º–≤–æ–ª payload) —É–¥–≤–∞–∏–≤–∞–µ—Ç—Å—è.
    total = _luhn_mod30_sum(payload, start_double=True)
    check_val = (30 - (total % 30)) % 30
    return MOD30_ALPHABET[check_val]

def generate_openmrs_id(payload_length: int = 7) -> str:
    payload = "".join(random.choices(MOD30_ALPHABET, k=payload_length))
    return payload + luhn_mod30_check_char(payload)

def get_openmrs_id_identifier() -> Tuple[str, str]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (uuid —Ç–∏–ø–∞ 'OpenMRS ID', generated_identifier_value),
    –≥–¥–µ identifier_value –ø—Ä–æ—Ö–æ–¥–∏—Ç LuhnMod30IdentifierValidator.
    """
    url = f"{BASE_URL}/patientidentifiertype"
    resp = requests.get(
        url,
        params={"v": "default"},
        auth=HTTPBasicAuth(USERNAME, PASSWORD),
        headers={"Accept": "application/json"},
    )
    resp.raise_for_status()

    for item in resp.json().get("results", []):
        if item.get("name") == "OpenMRS ID":
            return item["uuid"], generate_openmrs_id(payload_length=7)

    raise RuntimeError("PatientIdentifierType 'OpenMRS ID' not found")


====================================================================================================
MODULE: request_modules.visit.create_visit
PATH:   request_modules/visit/create_visit.py
====================================================================================================

# request_modules/visit/create_visit.py

import requests
from requests.auth import HTTPBasicAuth

BASE_URL = "http://localhost/openmrs/ws/rest/v1"


def create_visit(
    *,
    username: str,
    password: str,
    patient_uuid: str,
    visit_type_uuid: str,
    start_datetime_iso: str,
    location_uuid: str | None = None,
    stop_datetime_iso: str | None = None,
) -> requests.Response:
    """
    POST /visit
    payload –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å REST docs: patient, visitType, startDatetime, location, stopDatetime...
    :contentReference[oaicite:1]{index=1}
    """
    payload: dict = {
        "patient": patient_uuid,
        "visitType": visit_type_uuid,
        "startDatetime": start_datetime_iso,
    }
    if location_uuid is not None:
        payload["location"] = location_uuid
    if stop_datetime_iso is not None:
        payload["stopDatetime"] = stop_datetime_iso

    resp = requests.post(
        f"{BASE_URL}/visit",
        json=payload,
        auth=HTTPBasicAuth(username, password),
        headers={"Accept": "application/json", "Content-Type": "application/json"},
        timeout=30,
    )
    return resp


def fetch_visit_full(*, username: str, password: str, visit_uuid: str) -> dict:
    r = requests.get(
        f"{BASE_URL}/visit/{visit_uuid}",
        params={"v": "full"},
        auth=HTTPBasicAuth(username, password),
        headers={"Accept": "application/json"},
        timeout=30,
    )
    r.raise_for_status()
    return r.json()


====================================================================================================
MODULE: request_modules.visittype.get_random_valid_visit_type
PATH:   request_modules/visittype/get_random_valid_visit_type.py
====================================================================================================

# request_modules/visittype/get_random_valid_visit_type.py

import random
import requests
from requests.auth import HTTPBasicAuth

BASE_URL = "http://localhost/openmrs/ws/rest/v1"
USERNAME = "admin"
PASSWORD = "Admin123"


def get_random_valid_visit_type() -> dict:
    url = f"{BASE_URL}/visittype"
    r = requests.get(
        url,
        params={"v": "default"},
        auth=HTTPBasicAuth(USERNAME, PASSWORD),
        headers={"Accept": "application/json"},
        timeout=30,
    )
    r.raise_for_status()

    results = r.json().get("results", []) or []
    if not results:
        raise RuntimeError("VisitType list is empty")

    return random.choice(results)


====================================================================================================
MODULE: roles.create_role_with_add_patients_only
PATH:   roles/create_role_with_add_patients_only.py
====================================================================================================

# –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

import requests
from requests.auth import HTTPBasicAuth

BASE_URL = "http://localhost/openmrs/ws/rest/v1"
auth = HTTPBasicAuth("admin", "Admin123")

ROLE_NAME = "Custom: Add Patients Only"
DESCRIPTION = "Can add patients but cannot add people/identifiers"

def create_role():
    r = requests.post(
        f"{BASE_URL}/role",
        json={
            "name": ROLE_NAME,
            "description": DESCRIPTION,
        },
        headers={"Accept": "application/json", "Content-Type": "application/json"},
        auth=auth,
        timeout=30,
    )
    print("create role status:", r.status_code)
    print(r.text)
    r.raise_for_status()
    return r.json()

if __name__ == "__main__":
    created = create_role()
    print("role uuid:", created.get("uuid"))


====================================================================================================
MODULE: roles.get_all_roles
PATH:   roles/get_all_roles.py
====================================================================================================

import requests
from requests.auth import HTTPBasicAuth

BASE_URL = "http://localhost/openmrs/ws/rest/v1"
auth = HTTPBasicAuth("admin", "Admin123")

url = f"{BASE_URL}/role?v=default&limit=100"
data = requests.get(url, auth=auth, headers={"Accept": "application/json"}).json()

for r in data.get("results", []):
    print(r.get("display"), r.get("uuid"))


====================================================================================================
MODULE: roles.get_get_role_privileges
PATH:   roles/get_get_role_privileges.py
====================================================================================================

import requests
from requests.auth import HTTPBasicAuth

BASE_URL = "http://localhost/openmrs/ws/rest/v1"
auth = HTTPBasicAuth("admin", "Admin123")

ROLE_UUIDS = [
    "246f8412-01fb-4e55-86d7-6441cd1b81a5",
    "a142aa96-772a-4d09-b80c-b3a78687b189",
    "d8ddab2c-20a5-4a3c-b209-856c7fe839cd",
    "7f04f24c-e433-4bc7-95cd-975b6f003207",
    "66fa1ec4-5d30-4127-a693-d8b1f9519a14",
    "9873dba9-484f-42c2-a98d-f224bd65117a",
    "dc978fe8-b574-4e11-be54-626ae2d28ed8",
    "eba658df-fa88-4dab-b000-57e1e5cb2e43",
    "fb393086-d6ec-4bcb-a300-5815a554c4ae",
    "2d09a0e2-240a-4dd7-9c3e-9e2cd2cb2d1f",
    "58f60da3-03bd-4b57-bb3c-429b50f6939b",
    "564b560e-3fe8-4829-8be4-68ddb40cf106",
    "93a9c2f8-9296-488f-9451-43667e1c4d7f",
    "f7fd42ef-880e-40c5-972d-e4ae7c990de2",
    "2083fd40-3391-11ed-a667-507b9dea1806",
    "d210eb66-2188-11ed-9dff-507b9dea1806",
    "84bdd876-4694-11ed-8109-00155dcc3fc0",
    "cca4be4b-2188-11ed-9dff-507b9dea1806",
    "8ee2f2ac-467f-11ed-8109-00155dcc3fc0",
    "a49be648-6b0a-11ed-93a2-806d973f13a9",
    "4ef1f0f9-fee6-414b-910d-28e17df345c2",
    "2749cd1b-251a-4d8b-bc35-0165f2b1af3e",
    "fab43ac4-79bc-4f3d-805b-bd3a82ce41e9",
    "2f087f90-9c47-4262-bfce-23c7862e727e",
    "ab2160f6-0941-430c-9752-6714353fbd3c",
    "f089471c-e00b-468e-96e8-46aea1b339af",
    "8d94f280-c2cc-11de-8d13-0010c6dffd0f",
    "7d8d214d-2188-11ed-9dff-507b9dea1806",
    "8d94f852-c2cc-11de-8d13-0010c6dffd0f",
]

def get_role_privileges(role_uuid: str):
    url = f"{BASE_URL}/role/{role_uuid}"
    r = requests.get(
        url,
        params={"v": "full"},
        headers={"Accept": "application/json"},
        auth=auth,
        timeout=30,
    )

    print(f"\n=== ROLE {role_uuid} ===")
    print("status:", r.status_code)

    r.raise_for_status()
    data = r.json()

    role_name = data.get("display") or data.get("name")
    print("role:", role_name)

    privileges = data.get("privileges", [])
    if not privileges:
        print("  (no privileges)")
        return

    for p in privileges:
        print(" -", p.get("display"))

if __name__ == "__main__":
    for role_uuid in ROLE_UUIDS:
        try:
            get_role_privileges(role_uuid)
        except requests.HTTPError as e:
            print("ERROR:", e)
        except requests.RequestException as e:
            print("REQUEST ERROR:", e)


====================================================================================================
MODULE: roles.get_roles_with_add_identifiers
PATH:   roles/get_roles_with_add_identifiers.py
====================================================================================================

import requests
from requests.auth import HTTPBasicAuth

BASE_URL = "http://localhost/openmrs/ws/rest/v1"
auth = HTTPBasicAuth("admin", "Admin123")

ROLE_UUIDS = [
    "246f8412-01fb-4e55-86d7-6441cd1b81a5",
    "a142aa96-772a-4d09-b80c-b3a78687b189",
    "d8ddab2c-20a5-4a3c-b209-856c7fe839cd",
    "7f04f24c-e433-4bc7-95cd-975b6f003207",
    "66fa1ec4-5d30-4127-a693-d8b1f9519a14",
    "9873dba9-484f-42c2-a98d-f224bd65117a",
    "dc978fe8-b574-4e11-be54-626ae2d28ed8",
    "eba658df-fa88-4dab-b000-57e1e5cb2e43",
    "fb393086-d6ec-4bcb-a300-5815a554c4ae",
    "2d09a0e2-240a-4dd7-9c3e-9e2cd2cb2d1f",
    "58f60da3-03bd-4b57-bb3c-429b50f6939b",
    "564b560e-3fe8-4829-8be4-68ddb40cf106",
    "93a9c2f8-9296-488f-9451-43667e1c4d7f",
    "f7fd42ef-880e-40c5-972d-e4ae7c990de2",
    "2083fd40-3391-11ed-a667-507b9dea1806",
    "d210eb66-2188-11ed-9dff-507b9dea1806",
    "84bdd876-4694-11ed-8109-00155dcc3fc0",
    "cca4be4b-2188-11ed-9dff-507b9dea1806",
    "8ee2f2ac-467f-11ed-8109-00155dcc3fc0",
    "a49be648-6b0a-11ed-93a2-806d973f13a9",
    "4ef1f0f9-fee6-414b-910d-28e17df345c2",
    "2749cd1b-251a-4d8b-bc35-0165f2b1af3e",
    "fab43ac4-79bc-4f3d-805b-bd3a82ce41e9",
    "2f087f90-9c47-4262-bfce-23c7862e727e",
    "ab2160f6-0941-430c-9752-6714353fbd3c",
    "f089471c-e00b-468e-96e8-46aea1b339af",
    "8d94f280-c2cc-11de-8d13-0010c6dffd0f",
    "7d8d214d-2188-11ed-9dff-507b9dea1806",
    "8d94f852-c2cc-11de-8d13-0010c6dffd0f",
]

if __name__ == "__main__":
    print("Roles with privilege: Add People\n")

    for role_uuid in ROLE_UUIDS:
        r = requests.get(
            f"{BASE_URL}/role/{role_uuid}",
            params={"v": "full"},
            auth=auth,
        )
        r.raise_for_status()
        data = r.json()

        privileges = {p.get("display") for p in data.get("privileges", [])}

        if "Add Patient Identifiers" in privileges:
            print(f"- {data.get('display')} ({role_uuid})")


====================================================================================================
MODULE: roles.get_roles_with_add_patient
PATH:   roles/get_roles_with_add_patient.py
====================================================================================================

import requests
from requests.auth import HTTPBasicAuth

BASE_URL = "http://localhost/openmrs/ws/rest/v1"
auth = HTTPBasicAuth("admin", "Admin123")

ROLE_UUIDS = [
    "246f8412-01fb-4e55-86d7-6441cd1b81a5",
    "a142aa96-772a-4d09-b80c-b3a78687b189",
    "d8ddab2c-20a5-4a3c-b209-856c7fe839cd",
    "7f04f24c-e433-4bc7-95cd-975b6f003207",
    "66fa1ec4-5d30-4127-a693-d8b1f9519a14",
    "9873dba9-484f-42c2-a98d-f224bd65117a",
    "dc978fe8-b574-4e11-be54-626ae2d28ed8",
    "eba658df-fa88-4dab-b000-57e1e5cb2e43",
    "fb393086-d6ec-4bcb-a300-5815a554c4ae",
    "2d09a0e2-240a-4dd7-9c3e-9e2cd2cb2d1f",
    "58f60da3-03bd-4b57-bb3c-429b50f6939b",
    "564b560e-3fe8-4829-8be4-68ddb40cf106",
    "93a9c2f8-9296-488f-9451-43667e1c4d7f",
    "f7fd42ef-880e-40c5-972d-e4ae7c990de2",
    "2083fd40-3391-11ed-a667-507b9dea1806",
    "d210eb66-2188-11ed-9dff-507b9dea1806",
    "84bdd876-4694-11ed-8109-00155dcc3fc0",
    "cca4be4b-2188-11ed-9dff-507b9dea1806",
    "8ee2f2ac-467f-11ed-8109-00155dcc3fc0",
    "a49be648-6b0a-11ed-93a2-806d973f13a9",
    "4ef1f0f9-fee6-414b-910d-28e17df345c2",
    "2749cd1b-251a-4d8b-bc35-0165f2b1af3e",
    "fab43ac4-79bc-4f3d-805b-bd3a82ce41e9",
    "2f087f90-9c47-4262-bfce-23c7862e727e",
    "ab2160f6-0941-430c-9752-6714353fbd3c",
    "f089471c-e00b-468e-96e8-46aea1b339af",
    "8d94f280-c2cc-11de-8d13-0010c6dffd0f",
    "7d8d214d-2188-11ed-9dff-507b9dea1806",
    "8d94f852-c2cc-11de-8d13-0010c6dffd0f",
]

if __name__ == "__main__":
    print("Roles with privilege: Add Patients\n")

    for role_uuid in ROLE_UUIDS:
        r = requests.get(
            f"{BASE_URL}/role/{role_uuid}",
            params={"v": "full"},
            auth=auth,
        )
        r.raise_for_status()
        data = r.json()

        privileges = {p.get("display") for p in data.get("privileges", [])}

        if "Add Patients" in privileges:
            print(f"- {data.get('display')} ({role_uuid})")


====================================================================================================
MODULE: roles.get_roles_with_add_people
PATH:   roles/get_roles_with_add_people.py
====================================================================================================

import requests
from requests.auth import HTTPBasicAuth

BASE_URL = "http://localhost/openmrs/ws/rest/v1"
auth = HTTPBasicAuth("admin", "Admin123")

ROLE_UUIDS = [
    "246f8412-01fb-4e55-86d7-6441cd1b81a5",
    "a142aa96-772a-4d09-b80c-b3a78687b189",
    "d8ddab2c-20a5-4a3c-b209-856c7fe839cd",
    "7f04f24c-e433-4bc7-95cd-975b6f003207",
    "66fa1ec4-5d30-4127-a693-d8b1f9519a14",
    "9873dba9-484f-42c2-a98d-f224bd65117a",
    "dc978fe8-b574-4e11-be54-626ae2d28ed8",
    "eba658df-fa88-4dab-b000-57e1e5cb2e43",
    "fb393086-d6ec-4bcb-a300-5815a554c4ae",
    "2d09a0e2-240a-4dd7-9c3e-9e2cd2cb2d1f",
    "58f60da3-03bd-4b57-bb3c-429b50f6939b",
    "564b560e-3fe8-4829-8be4-68ddb40cf106",
    "93a9c2f8-9296-488f-9451-43667e1c4d7f",
    "f7fd42ef-880e-40c5-972d-e4ae7c990de2",
    "2083fd40-3391-11ed-a667-507b9dea1806",
    "d210eb66-2188-11ed-9dff-507b9dea1806",
    "84bdd876-4694-11ed-8109-00155dcc3fc0",
    "cca4be4b-2188-11ed-9dff-507b9dea1806",
    "8ee2f2ac-467f-11ed-8109-00155dcc3fc0",
    "a49be648-6b0a-11ed-93a2-806d973f13a9",
    "4ef1f0f9-fee6-414b-910d-28e17df345c2",
    "2749cd1b-251a-4d8b-bc35-0165f2b1af3e",
    "fab43ac4-79bc-4f3d-805b-bd3a82ce41e9",
    "2f087f90-9c47-4262-bfce-23c7862e727e",
    "ab2160f6-0941-430c-9752-6714353fbd3c",
    "f089471c-e00b-468e-96e8-46aea1b339af",
    "8d94f280-c2cc-11de-8d13-0010c6dffd0f",
    "7d8d214d-2188-11ed-9dff-507b9dea1806",
    "8d94f852-c2cc-11de-8d13-0010c6dffd0f",
]

if __name__ == "__main__":
    print("Roles with privilege: Add People\n")

    for role_uuid in ROLE_UUIDS:
        r = requests.get(
            f"{BASE_URL}/role/{role_uuid}",
            params={"v": "full"},
            auth=auth,
        )
        r.raise_for_status()
        data = r.json()

        privileges = {p.get("display") for p in data.get("privileges", [])}

        if "Add People" in privileges:
            print(f"- {data.get('display')} ({role_uuid})")


====================================================================================================
MODULE: roles.get_roles_with_edit_patient_identifiers
PATH:   roles/get_roles_with_edit_patient_identifiers.py
====================================================================================================

import requests
from requests.auth import HTTPBasicAuth

BASE_URL = "http://localhost/openmrs/ws/rest/v1"
auth = HTTPBasicAuth("admin", "Admin123")

ROLE_UUIDS = [
    "246f8412-01fb-4e55-86d7-6441cd1b81a5",
    "a142aa96-772a-4d09-b80c-b3a78687b189",
    "d8ddab2c-20a5-4a3c-b209-856c7fe839cd",
    "7f04f24c-e433-4bc7-95cd-975b6f003207",
    "66fa1ec4-5d30-4127-a693-d8b1f9519a14",
    "9873dba9-484f-42c2-a98d-f224bd65117a",
    "dc978fe8-b574-4e11-be54-626ae2d28ed8",
    "eba658df-fa88-4dab-b000-57e1e5cb2e43",
    "fb393086-d6ec-4bcb-a300-5815a554c4ae",
    "2d09a0e2-240a-4dd7-9c3e-9e2cd2cb2d1f",
    "58f60da3-03bd-4b57-bb3c-429b50f6939b",
    "564b560e-3fe8-4829-8be4-68ddb40cf106",
    "93a9c2f8-9296-488f-9451-43667e1c4d7f",
    "f7fd42ef-880e-40c5-972d-e4ae7c990de2",
    "2083fd40-3391-11ed-a667-507b9dea1806",
    "d210eb66-2188-11ed-9dff-507b9dea1806",
    "84bdd876-4694-11ed-8109-00155dcc3fc0",
    "cca4be4b-2188-11ed-9dff-507b9dea1806",
    "8ee2f2ac-467f-11ed-8109-00155dcc3fc0",
    "a49be648-6b0a-11ed-93a2-806d973f13a9",
    "4ef1f0f9-fee6-414b-910d-28e17df345c2",
    "2749cd1b-251a-4d8b-bc35-0165f2b1af3e",
    "fab43ac4-79bc-4f3d-805b-bd3a82ce41e9",
    "2f087f90-9c47-4262-bfce-23c7862e727e",
    "ab2160f6-0941-430c-9752-6714353fbd3c",
    "f089471c-e00b-468e-96e8-46aea1b339af",
    "8d94f280-c2cc-11de-8d13-0010c6dffd0f",
    "7d8d214d-2188-11ed-9dff-507b9dea1806",
    "8d94f852-c2cc-11de-8d13-0010c6dffd0f",
]

if __name__ == "__main__":
    print("Roles with privilege: Add People\n")

    for role_uuid in ROLE_UUIDS:
        r = requests.get(
            f"{BASE_URL}/role/{role_uuid}",
            params={"v": "full"},
            auth=auth,
        )
        r.raise_for_status()
        data = r.json()

        privileges = {p.get("display") for p in data.get("privileges", [])}

        if "Edit Patient Identifiers" in privileges:
            print(f"- {data.get('display')} ({role_uuid})")


====================================================================================================
MODULE: roles.get_without_any_patient_creation_privileges
PATH:   roles/get_without_any_patient_creation_privileges.py
====================================================================================================

import requests
from requests.auth import HTTPBasicAuth

BASE_URL = "http://localhost/openmrs/ws/rest/v1"
auth = HTTPBasicAuth("admin", "Admin123")

ROLE_UUIDS = [
    "246f8412-01fb-4e55-86d7-6441cd1b81a5",
    "a142aa96-772a-4d09-b80c-b3a78687b189",
    "d8ddab2c-20a5-4a3c-b209-856c7fe839cd",
    "7f04f24c-e433-4bc7-95cd-975b6f003207",
    "66fa1ec4-5d30-4127-a693-d8b1f9519a14",
    "9873dba9-484f-42c2-a98d-f224bd65117a",
    "dc978fe8-b574-4e11-be54-626ae2d28ed8",
    "eba658df-fa88-4dab-b000-57e1e5cb2e43",
    "fb393086-d6ec-4bcb-a300-5815a554c4ae",
    "2d09a0e2-240a-4dd7-9c3e-9e2cd2cb2d1f",
    "58f60da3-03bd-4b57-bb3c-429b50f6939b",
    "564b560e-3fe8-4829-8be4-68ddb40cf106",
    "93a9c2f8-9296-488f-9451-43667e1c4d7f",
    "f7fd42ef-880e-40c5-972d-e4ae7c990de2",
    "2083fd40-3391-11ed-a667-507b9dea1806",
    "d210eb66-2188-11ed-9dff-507b9dea1806",
    "84bdd876-4694-11ed-8109-00155dcc3fc0",
    "cca4be4b-2188-11ed-9dff-507b9dea1806",
    "8ee2f2ac-467f-11ed-8109-00155dcc3fc0",
    "a49be648-6b0a-11ed-93a2-806d973f13a9",
    "4ef1f0f9-fee6-414b-910d-28e17df345c2",
    "2749cd1b-251a-4d8b-bc35-0165f2b1af3e",
    "fab43ac4-79bc-4f3d-805b-bd3a82ce41e9",
    "2f087f90-9c47-4262-bfce-23c7862e727e",
    "ab2160f6-0941-430c-9752-6714353fbd3c",
    "f089471c-e00b-468e-96e8-46aea1b339af",
    "8d94f280-c2cc-11de-8d13-0010c6dffd0f",
    "7d8d214d-2188-11ed-9dff-507b9dea1806",
    "8d94f852-c2cc-11de-8d13-0010c6dffd0f",
]
NEEDED = {"Add Patients"}
NICE_TO_HAVE = {
    "Add People",
    "Add Patient Identifiers",
    "Edit Patient Identifiers",
}
BLOCKED_PRIVS = NEEDED | NICE_TO_HAVE

def fetch_role(role_uuid: str) -> dict:
    r = requests.get(
        f"{BASE_URL}/role/{role_uuid}",
        params={"v": "full"},
        headers={"Accept": "application/json"},
        auth=auth,
        timeout=30,
    )
    r.raise_for_status()
    return r.json()

if __name__ == "__main__":
    print("Roles WITHOUT any patient-creation privileges:\n")

    for role_uuid in ROLE_UUIDS:
        data = fetch_role(role_uuid)

        role_name = data.get("display") or data.get("name") or role_uuid
        privileges = {
            p.get("display")
            for p in data.get("privileges", [])
            if p.get("display")
        }

        if privileges.isdisjoint(BLOCKED_PRIVS):
            print(f"- {role_name} ({role_uuid})")


====================================================================================================
MODULE: script
PATH:   script.py
====================================================================================================

#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
–°–æ–±–∏—Ä–∞–µ—Ç Python-–º–æ–¥—É–ª–∏ –ø–æ –ø—Ä–æ–µ–∫—Ç—É –∏ —Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª.
–ü—Ä–∏–º–µ—Ä:
  python collect_modules.py --root . --out all_modules.txt
"""

from __future__ import annotations

import argparse
from pathlib import Path
from typing import Iterable, List, Optional, Set


DEFAULT_EXCLUDE_DIRS = {
    ".git", ".hg", ".svn",
    ".venv", "venv", "env",
    "__pycache__",
    ".mypy_cache", ".pytest_cache", ".ruff_cache",
    ".tox", ".nox",
    "node_modules",
    "dist", "build", ".eggs",
    ".idea", ".vscode",
}


def is_under_any_dir(path: Path, excluded_names: Set[str]) -> bool:
    """True –µ—Å–ª–∏ –≤ –ø—É—Ç–∏ –µ—Å—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å –∏–º–µ–Ω–µ–º –∏–∑ excluded_names."""
    return any(part in excluded_names for part in path.parts)


def find_python_package_root(file_path: Path, project_root: Path) -> Optional[Path]:
    """
    –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –∏–∑ –∫–æ—Ç–æ—Ä–æ–π –º–æ–∂–Ω–æ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å import-–ø—É—Ç—å:
    –ø–æ–¥–Ω–∏–º–∞–µ–º—Å—è –≤–≤–µ—Ä—Ö, –ø–æ–∫–∞ –µ—Å—Ç—å __init__.py; –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ù–ê–î –ø–∞–∫–µ—Ç–æ–º.
    """
    current = file_path.parent
    last_pkg_dir = None

    while True:
        if current == project_root.parent or current == current.parent:
            break
        if (current / "__init__.py").exists():
            last_pkg_dir = current
            current = current.parent
            continue
        break

    if last_pkg_dir is None:
        return None

    return last_pkg_dir.parent


def module_name_from_path(py_file: Path, project_root: Path) -> str:
    """
    –°—Ç—Ä–æ–∏–º –∏–º—è –º–æ–¥—É–ª—è:
    - –µ—Å–ª–∏ —Ñ–∞–π–ª –≤ –ø–∞–∫–µ—Ç–µ (–µ—Å—Ç—å __init__.py –ø–æ —Ü–µ–ø–æ—á–∫–µ) => package.sub.module
    - –∏–Ω–∞—á–µ => relative/path/to/file.py -> relative.path.to.file
    """
    pkg_root = find_python_package_root(py_file, project_root)
    if pkg_root is not None and pkg_root in py_file.parents:
        rel = py_file.relative_to(pkg_root)
    else:
        rel = py_file.relative_to(project_root)

    parts = list(rel.parts)
    if parts[-1].endswith(".py"):
        parts[-1] = parts[-1][:-3]

    # –ï—Å–ª–∏ —ç—Ç–æ __init__.py, —Ç–æ –º–æ–¥—É–ª—å = –∏–º—è –ø–∞–∫–µ—Ç–∞
    if parts[-1] == "__init__":
        parts = parts[:-1] or parts  # –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –∫–æ—Ä–Ω–µ–≤–æ–π __init__.py

    return ".".join(parts)


def iter_py_files(
    root: Path,
    exclude_dirs: Set[str],
    include_init: bool,
) -> Iterable[Path]:
    for p in root.rglob("*.py"):
        if not p.is_file():
            continue
        if is_under_any_dir(p, exclude_dirs):
            continue
        if not include_init and p.name == "__init__.py":
            continue
        yield p


def write_merged_file(files: List[Path], root: Path, out_path: Path) -> None:
    out_path.parent.mkdir(parents=True, exist_ok=True)

    # –°—Ç–∞–±–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
    files = sorted(files, key=lambda x: str(x).lower())

    with out_path.open("w", encoding="utf-8", newline="\n") as out:
        out.write("# Collected project modules\n")
        out.write(f"# Root: {root.resolve()}\n")
        out.write(f"# Files: {len(files)}\n\n")

        for py_file in files:
            mod_name = module_name_from_path(py_file, root)
            rel_path = py_file.relative_to(root)

            try:
                content = py_file.read_text(encoding="utf-8")
            except UnicodeDecodeError:
                # –Ω–∞ —Å–ª—É—á–∞–π —Ñ–∞–π–ª–æ–≤ –Ω–µ –≤ utf-8 ‚Äî —á–∏—Ç–∞–µ–º –∫–∞–∫ bytes –∏ –ø—Ä–æ–±—É–µ–º –∑–∞–º–µ–Ω–∏—Ç—å
                content = py_file.read_bytes().decode("utf-8", errors="replace")

            out.write("\n" + "=" * 100 + "\n")
            out.write(f"MODULE: {mod_name}\n")
            out.write(f"PATH:   {rel_path.as_posix()}\n")
            out.write("=" * 100 + "\n\n")
            out.write(content.rstrip() + "\n")  # –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ–º –±–ª–æ–∫
            out.write("\n")  # –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(description="Collect Python modules into one file.")
    parser.add_argument("--root", type=str, default=".", help="Project root directory")
    parser.add_argument("--out", type=str, default="all_modules.txt", help="Output file path")
    parser.add_argument(
        "--exclude-dir",
        action="append",
        default=[],
        help="Directory name to exclude (can be used multiple times)",
    )
    parser.add_argument(
        "--include-init",
        action="store_true",
        help="Include __init__.py files (default: excluded)",
    )
    return parser.parse_args()


def main() -> None:
    args = parse_args()
    root = Path(args.root).resolve()
    out_path = Path(args.out).resolve()

    exclude_dirs = set(DEFAULT_EXCLUDE_DIRS)
    exclude_dirs.update(args.exclude_dir or [])

    py_files = list(iter_py_files(root, exclude_dirs, include_init=args.include_init))
    write_merged_file(py_files, root, out_path)

    print(f"OK: collected {len(py_files)} modules into: {out_path}")


if __name__ == "__main__":
    main()


====================================================================================================
MODULE: src.openmrs_patient
PATH:   src/openmrs_patient.py
====================================================================================================

"""
openmrs_patient.py

–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç OpenMRS REST API –¥–ª—è integration-—Ç–µ—Å—Ç–æ–≤.
BASE_URL –∑–∞—à–∏—Ç –≤ OpenMRSClient.
"""

from dataclasses import dataclass, asdict
from typing import Dict, List, Optional

import requests
from requests.auth import HTTPBasicAuth


# -----------------------------
# dataclasses
# -----------------------------

@dataclass
class PersonName:
    givenName: str
    familyName: str
    middleName: Optional[str] = None


@dataclass
class Address:
    address1: str
    cityVillage: str
    country: str


@dataclass
class Person:
    names: List[PersonName]
    gender: str
    birthdate: str
    addresses: Optional[List[Address]] = None


@dataclass
class Identifier:
    identifier: str
    identifierType: str
    location: str
    preferred: bool = True


@dataclass
class PatientPayload:
    person: Person
    identifiers: List[Identifier]

    def to_dict(self) -> Dict:
        return asdict(self)


# -----------------------------
# client
# -----------------------------

class OpenMRSClient:
    """
    –ü—Ä–æ—Å—Ç–æ–π –∫–ª–∏–µ–Ω—Ç OpenMRS REST API.

    BASE_URL —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ –ª–æ–∫–∞–ª—å–Ω—ã–π OpenMRS.
    """

    BASE_URL = "http://localhost/openmrs/ws/rest/v1"
    headers = {
        "Content-Type": "application/json",
        "Accept": "application/json",
    }


    def __init__(self, username: str, password: str) -> None:
        self.auth = HTTPBasicAuth(username, password)


    def create_patient(self, payload: PatientPayload) -> Dict:
        resp = requests.post(
            f"{self.BASE_URL}/patient",
            headers=self.headers,
            json=payload.to_dict(),
            auth=self.auth,
        )

        if resp.status_code not in (200, 201):
            raise RuntimeError(
                f"OpenMRS error {resp.status_code}: {resp.text}"
            )

        return resp.json()


====================================================================================================
MODULE: tests.new_patient.test_create_patient_with_already_created_person_validate_identifier_field
PATH:   tests/new_patient/test_create_patient_with_already_created_person_validate_identifier_field.py
====================================================================================================

import uuid
import pytest

from request_modules.create_random_valid_person import create_valid_person
from request_modules.create_valid_patient_with_person import create_in_valid_patient_with_person
from request_modules.locations.get_random_valid_location import get_random_valid_location
from request_modules.patientidentifiertype.get_random_valid_patient_identifier_type import get_openmrs_id_identifier
from src.openmrs_patient import Person


@pytest.mark.parametrize(
    "invalid_patient_identifier",
    [
        #https://app.testiny.io/p/1/testcases/tcf/59
        # –°—Ü–µ–Ω–∞—Ä–∏–π: identifier –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (null) / –Ω–µ –∑–∞–¥–∞–Ω.
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: OpenMRS –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ ‚Üí HTTP 400,
        #                      –≤ —Ç–µ–∫—Å—Ç–µ –æ—à–∏–±–∫–∏ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è identifier.
        None,
        #https://app.testiny.io/p/1/testcases/tcf/51
        # –°—Ü–µ–Ω–∞—Ä–∏–π: identifier –∑–∞–¥–∞–Ω –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π.
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400 + –æ—à–∏–±–∫–∞ –ø—Ä–æ identifier.
        "",
        #https://app.testiny.io/p/1/testcases/tcf/53
        # –°—Ü–µ–Ω–∞—Ä–∏–π: identifier —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π .
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400 + –æ—à–∏–±–∫–∞ –ø—Ä–æ identifier.
        "a",
        #https://app.testiny.io/p/1/testcases/tcf/54
        # –°—Ü–µ–Ω–∞—Ä–∏–π: identifier —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä #),
        #           –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ —Ñ–æ—Ä–º–∞—Ç—É.
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400 + –æ—à–∏–±–∫–∞ –ø—Ä–æ identifier.
        "MRN#123",
        #https://app.testiny.io/p/1/testcases/tcf/56
        # –°—Ü–µ–Ω–∞—Ä–∏–π: identifier —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Ö–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü—ã –¥–ª–∏–Ω—ã / overflow risk).
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400 + –æ—à–∏–±–∫–∞ –ø—Ä–æ identifier.
        "A" * 256,
        #https://app.testiny.io/p/1/testcases/tcf/57
        # –°—Ü–µ–Ω–∞—Ä–∏–π: identifier –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ç–∏–ø–∞ (int –≤–º–µ—Å—Ç–æ —Å—Ç—Ä–æ–∫–∏),
        #           –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏/—Ç–∏–ø–æ–≤.
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400 + –æ—à–∏–±–∫–∞ –ø—Ä–æ identifier.
        123456,
    ],
)
def test_create_patient_with_invalid_patient_identifier(invalid_patient_identifier):
    """
    –°—Ü–µ–Ω–∞—Ä–∏–π (–æ–±—â–∏–π): —Å–æ–∑–¥–∞—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞ –ø–æ API /patient —Å —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω–æ–π Person,
    –Ω–æ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –ù–ï–≤–∞–ª–∏–¥–Ω—ã–π patient identifier.

    –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–æ–±—â–∏–π): OpenMRS –ù–ï —Å–æ–∑–¥–∞—ë—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTTP 400,
    –≤ —Ç–µ–∫—Å—Ç–µ –æ—Ç–≤–µ—Ç–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ identifier/Identifier.
    """
    # –ë–µ—Ä—ë–º UUID —Ç–∏–ø–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ "OpenMRS ID" (–∏ –≤–∞–ª–∏–¥–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏—è),
    # –Ω–æ –≤ —Ç–µ—Å—Ç–µ –º—ã –ü–ï–†–ï–ó–ê–¢–†–Å–ú –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ invalid_patient_identifier.
    identifier_type, _valid_identifier = get_openmrs_id_identifier()

    # –ë–µ—Ä—ë–º —Å–ª—É—á–∞–π–Ω—É—é –≤–∞–ª–∏–¥–Ω—É—é –ª–æ–∫–∞—Ü–∏—é (–≤ OpenMRS identifier –æ–±—ã—á–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ location)
    location = get_random_valid_location()

    # –°–æ–∑–¥–∞—ë–º –≤–∞–ª–∏–¥–Ω—É—é Person –∑–∞—Ä–∞–Ω–µ–µ (—Å—Ü–µ–Ω–∞—Ä–∏–π: patient —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–∞ –±–∞–∑–µ —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω–æ–π person)
    person: Person = create_valid_person()

    # –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞ —Å –ù–ï–≤–∞–ª–∏–¥–Ω—ã–º identifier
    response = create_in_valid_patient_with_person(
        username="admin",
        password="Admin123",
        location=location,
        identifier_type=identifier_type,
        patient_identifier=invalid_patient_identifier,
        person=person,
    )

    # –û–∂–∏–¥–∞–µ–º –æ—Ç–∫–∞–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ OpenMRS
    assert response.status_code == 400
    assert "identifier" in response.text or "Identifier" in response.text


====================================================================================================
MODULE: tests.new_patient.test_create_patient_with_already_created_person_validate_location_field
PATH:   tests/new_patient/test_create_patient_with_already_created_person_validate_location_field.py
====================================================================================================

import uuid
import pytest

from request_modules.create_random_valid_person import create_valid_person
from request_modules.create_valid_patient_with_person import create_in_valid_patient_with_person
from request_modules.locations.get_random_valid_location import get_random_valid_location
from request_modules.patientidentifiertype.get_random_valid_patient_identifier_type import (
    get_openmrs_id_identifier,
)
from src.openmrs_patient import Person


# TODO:
# –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π UUID –ª–æ–∫–∞—Ü–∏–∏,
# –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª —É–¥–∞–ª—ë–Ω/retired, –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–µ–π—Å.



# ============================================================
# –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ —Å —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω–æ–π Person
# –∏ —Å –ù–ï–≤–∞–ª–∏–¥–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ location
# ============================================================

@pytest.mark.parametrize(
    "location",
    [   #https://app.testiny.io/p/1/testcases/tcf/41/tc/76
        # –°—Ü–µ–Ω–∞—Ä–∏–π: location –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (null) / –Ω–µ –∑–∞–¥–∞–Ω.
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: OpenMRS –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ ‚Üí HTTP 400,
        #
        None,
        #https://app.testiny.io/p/1/testcases/tcf/41/tc/60
        # –°—Ü–µ–Ω–∞—Ä–∏–π: location –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–∞–∫ —á–∏—Å–ª–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400 (–Ω–µ UUID –∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–∫–∞—Ü–∏—è)
        "10",

        #https://app.testiny.io/p/1/testcases/tcf/41/tc/62
        # –°—Ü–µ–Ω–∞—Ä–∏–π: location ‚Äî –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400
        "abc",

        #https://app.testiny.io/p/1/testcases/tcf/41/tc/63
        # –°—Ü–µ–Ω–∞—Ä–∏–π: location ‚Äî –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400
        "",

        #https://app.testiny.io/p/1/testcases/tcf/41/tc/65
        # –°—Ü–µ–Ω–∞—Ä–∏–π: location –∏–º–µ–µ—Ç —Ñ–æ—Ä–º–∞—Ç UUID,
        # –Ω–æ —Ç–∞–∫–æ–≥–æ UUID –ù–ï–¢ —Å—Ä–µ–¥–∏ –ª–æ–∫–∞—Ü–∏–π OpenMRS
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400
        "b52ec6f9-0e26-424c-a4a1-c64f9d571eb3",
    ]
)
def test_create_patient_with_person_and_invalid_location(location):
    """
    –û–±—â–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π:
    –°–æ–∑–¥–∞—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞ —Å –≤–∞–ª–∏–¥–Ω–æ–π Person –∏ –≤–∞–ª–∏–¥–Ω—ã–º identifier,
    –Ω–æ —Å –ù–ï–≤–∞–ª–∏–¥–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –ø–æ–ª—è location.

    –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
    OpenMRS –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å ‚Üí HTTP 400,
    –≤ —Ç–µ–∫—Å—Ç–µ –æ—Ç–≤–µ—Ç–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ location.
    """
    # –ü–æ–ª—É—á–∞–µ–º UUID —Ç–∏–ø–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ OpenMRS ID
    # –∏ –≤–∞–ª–∏–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ identifier
    identifier_type, patient_identifier = get_openmrs_id_identifier()

    # –°–æ–∑–¥–∞—ë–º –≤–∞–ª–∏–¥–Ω—É—é Person
    person: Person = create_valid_person()

    # –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞ —Å –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–π –ª–æ–∫–∞—Ü–∏–µ–π
    response = create_in_valid_patient_with_person(
        username="admin",
        password="Admin123",
        location=location,
        identifier_type=identifier_type,
        patient_identifier=patient_identifier,
        person=person,
    )

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ OpenMRS –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–∫–∞–∑–∞–ª
    assert response.status_code == 400
    assert "location" in response.text.lower()


====================================================================================================
MODULE: tests.new_patient.test_create_patient_with_already_created_person_with_different_users
PATH:   tests/new_patient/test_create_patient_with_already_created_person_with_different_users.py
====================================================================================================

import uuid
import pytest

from checks.patient_checks import assert_valid_patient_response
from request_modules.create_random_valid_person import create_valid_person
from request_modules.create_valid_patient_with_person import (
    create_valid_patient_with_person,
    create_in_valid_patient_with_person,
)
from request_modules.find_patient.find_patient import find_patient_by_identifier
from request_modules.locations.get_random_valid_location import get_random_valid_location
from request_modules.patientidentifiertype.get_random_valid_patient_identifier_type import (
    get_openmrs_id_identifier,
)
from src.openmrs_patient import Person





@pytest.mark.parametrize(
    "username,password,privilege_level_uuid",
    [   #https://app.testiny.io/p/1/testcases/tcf/43/tc/70/
        # –°—Ü–µ–Ω–∞—Ä–∏–π:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —É—Ä–æ–≤–Ω–µ–º –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π Full —Å–æ–∑–¥–∞—ë—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞ —Å –≤–∞–ª–∏–¥–Ω–æ–π Person,
        # –≤–∞–ª–∏–¥–Ω—ã–º OpenMRS ID –∏ –≤–∞–ª–∏–¥–Ω–æ–π location.
        #
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ —É—Å–ø–µ—à–Ω–æ (HTTP 201/200 –≤–Ω—É—Ç—Ä–∏ create_valid_patient_with_person),
        # –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞–ª–∏–¥–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞—Ü–∏–µ–Ω—Ç–∞,
        # –∏ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –ø–æ identifier (GET /patient?q=...).
        ("user124", "Password123", "ab2160f6-0941-430c-9752-6714353fbd3c"),  # Full
        #https://app.testiny.io/p/1/testcases/tcf/43/tc/71/
        # –°—Ü–µ–Ω–∞—Ä–∏–π:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —É—Ä–æ–≤–Ω–µ–º –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π High —Å–æ–∑–¥–∞—ë—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ.
        #
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ —É—Å–ø–µ—à–Ω–æ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –≤–∞–ª–∏–¥–Ω–∞,
        # –ø–∞—Ü–∏–µ–Ω—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ identifier.
        ("user125", "Password123", "f089471c-e00b-468e-96e8-46aea1b339af"),  # High
        #https://app.testiny.io/p/1/testcases/tcf/43/tc/72/
        # –°—Ü–µ–Ω–∞—Ä–∏–π:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "Doctor" (–Ω–µ full), –Ω–æ —Å –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è–º–∏ Add Patients,
        # —Å–æ–∑–¥–∞—ë—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞.
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ —É—Å–ø–µ—à–Ω–æ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –≤–∞–ª–∏–¥–Ω–∞,
        # –ø–∞—Ü–∏–µ–Ω—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ identifier.
        ("user220", "Password123", "4ef1f0f9-fee6-414b-910d-28e17df345c2"),  # Doctor (Add Patients)
    ],
)
def test_create_patient_with_user_has_access_add_patient(username, password, privilege_level_uuid):
    """
    –û–±—â–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π:
    –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è–º–∏ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞.

    –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
    - –£—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞.
    - –û—Ç–≤–µ—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç assert_valid_patient_response.
    - –ü–∞—Ü–∏–µ–Ω—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫ –ø–æ identifier.
    """
    identifier_type, patient_identifier = get_openmrs_id_identifier()
    location = get_random_valid_location()
    person: Person = create_valid_person()

    patient = create_valid_patient_with_person(
        username=username,
        password=password,
        location=location,
        identifier_type=identifier_type,
        patient_identifier=patient_identifier,
        person=person,
    )

    # –û–∂–∏–¥–∞–µ–º –≤–∞–ª–∏–¥–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞—Ü–∏–µ–Ω—Ç–∞ –≤ –æ—Ç–≤–µ—Ç–µ
    assert_valid_patient_response(patient)

    # –û–∂–∏–¥–∞–µ–º, —á—Ç–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –ø–æ identifier (GET /patient?q=identifier)
    found_patient = find_patient_by_identifier(identifier=patient_identifier)
    assert patient == found_patient


# ============================================================
# –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, —É –∫–æ—Ç–æ—Ä–æ–≥–æ –ù–ï–¢ –ø—Ä–∞–≤ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞
# ============================================================
#https://app.testiny.io/p/1/testcases/tcf/43/tc/73/
@pytest.mark.parametrize(
    "username,password,privilege_level_uuid",
    [
        # –°—Ü–µ–Ω–∞—Ä–∏–π:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø—Ä–∞–≤ –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞ user215 - Inventory Clerk
        #
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
        # –ó–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–∫–ª–æ–Ω—ë–Ω –∏–∑-–∑–∞ –Ω–µ—Ö–≤–∞—Ç–∫–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π.

        ("user215", "Password123", "4ef1f0f9-fee6-414b-910d-28e17df345c2"),
    ]
)
def test_create_patient_with_user_has_no_access_add_patient(username, password, privilege_level_uuid):
    """
    –°—Ü–µ–Ω–∞—Ä–∏–π:
    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ –ø—Ä–∞–≤ Add Patients –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞.

    –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
    - OpenMRS –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É –ø–æ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è–º (–æ–±—ã—á–Ω–æ 401/403 –∏–ª–∏ 400 —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º),
      –∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —É–∫–∞–∑–∞–Ω–æ, –∫–∞–∫–∏–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ —Ç—Ä–µ–±—É—é—Ç—Å—è.
    """
    identifier_type, patient_identifier = get_openmrs_id_identifier()
    location = get_random_valid_location()
    person: Person = create_valid_person()

    response = create_in_valid_patient_with_person(
        username=username,
        password=password,
        location=location,
        identifier_type=identifier_type,
        patient_identifier=patient_identifier,
        person=person,
    )

    # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é: –ù–ï—É—Å–ø–µ—à–Ω–æ
    assert response.status_code == 400, (
        "–û–∂–∏–¥–∞–ª–∏ –æ—Ç–∫–∞–∑ –ø–æ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è–º, –Ω–æ –ø–æ–ª—É—á–∏–ª–∏ —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞.\n"
        f"Body: {(response.text or '')[:2000]}"
    )

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ (–µ—Å–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–∫–∞—è)
    # –í OpenMRS —á–∞—Å—Ç–æ —ç—Ç–æ –±—É–¥–µ—Ç 401/403, –∞ —Ç–µ–ª–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∏–Ω—Å—Ç–∞–Ω—Å–∞.
    text = (response.text or "")
    assert "Privileges required" in text or "privilege" in text.lower()


# ============================================================
# –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –∫–æ—Ç–æ—Ä—ã–π disabled/retired (–∏–ª–∏ —Å–µ—Å—Å–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω–∞)
# ============================================================
#https://app.testiny.io/p/1/testcases/tcf/43/tc/74/
@pytest.mark.parametrize(
    "username,password,privilege_level_uuid",
    [
        # –°—Ü–µ–Ω–∞—Ä–∏–π:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞, –Ω–æ –∞–∫–∫–∞—É–Ω—Ç –≤—ã–∫–ª—é—á–µ–Ω/retired/disabled,
        # –∏–ª–∏ –≤ —Å–∏—Å—Ç–µ–º–µ –∑–∞–ø—Ä–µ—â–µ–Ω—ã –¥–µ–π—Å—Ç–≤–∏—è –∏–∑-–∑–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        #
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
        # –û—à–∏–±–∫–∞ (–æ–±—ã—á–Ω–æ 401/403/400) –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ—Ö–≤–∞—Ç–∫–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π/–¥–æ—Å—Ç—É–ø–∞.
        ("user225", "Password123", "4ef1f0f9-fee6-414b-910d-28e17df345c2"),
    ]
)
def test_create_patient_with_disabled_user(username, password, privilege_level_uuid):
    """
    –°—Ü–µ–Ω–∞—Ä–∏–π:
    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (disabled/retired) –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞.

    –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
    - –ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω—ë–Ω (HTTP 400/401/403).
    - –í —Ç–µ–∫—Å—Ç–µ –æ—Ç–≤–µ—Ç–∞ –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è—Ö
      (–≤ –¥–∞–Ω–Ω–æ–º —Ç–µ—Å—Ç–µ –æ–∂–∏–¥–∞–µ—Ç—Å—è "Privileges required: Get Identifier Types").
    """
    identifier_type, patient_identifier = get_openmrs_id_identifier()
    location = get_random_valid_location()
    person: Person = create_valid_person()

    response = create_in_valid_patient_with_person(
        username=username,
        password=password,
        location=location,
        identifier_type=identifier_type,
        patient_identifier=patient_identifier,
        person=person,
    )

    # –û–∂–∏–¥–∞–µ–º –æ—à–∏–±–∫—É
    assert response.status_code == 400, (
        f"–û–∂–∏–¥–∞–ª–∏ –æ—Ç–∫–∞–∑, –Ω–æ –ø–æ–ª—É—á–∏–ª–∏ {response.status_code}\n"
        f"Body: {(response.text or '')[:2000]}"
    )

    # –û–∂–∏–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è—Ö
    assert "Privileges required: Get Identifier Types" in (response.text or "")


====================================================================================================
MODULE: tests.new_patient.test_create_patient_with_already_created_person_with_invalid_identifier_type
PATH:   tests/new_patient/test_create_patient_with_already_created_person_with_invalid_identifier_type.py
====================================================================================================

import uuid
import pytest

from request_modules.create_random_valid_person import create_valid_person
from request_modules.create_valid_patient_with_person import create_in_valid_patient_with_person
from request_modules.locations.get_random_valid_location import get_random_valid_location
from request_modules.patientidentifiertype.get_random_valid_patient_identifier_type import get_openmrs_id_identifier


@pytest.mark.parametrize(
    "invalid_identifier_type",
    [   #https://app.testiny.io/p/1/testcases/tcf/75
        # –°—Ü–µ–Ω–∞—Ä–∏–π: identifierType –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (null) / –Ω–µ –∑–∞–¥–∞–Ω.
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: OpenMRS –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ ‚Üí HTTP 400,
        None,

        #https://app.testiny.io/p/1/testcases/tcf/42/tc/66
        # –°—Ü–µ–Ω–∞—Ä–∏–π: identifierType –ø–µ—Ä–µ–¥–∞–Ω –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π.
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: OpenMRS –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å ‚Üí HTTP 400,
        #                      –≤ —Ç–µ–∫—Å—Ç–µ –æ—à–∏–±–∫–∏ –µ—Å—Ç—å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ identifierType/identifier type.
        "",
        #https://app.testiny.io/p/1/testcases/tcf/42/tc/67
        # –°—Ü–µ–Ω–∞—Ä–∏–π: identifierType –ø–µ—Ä–µ–¥–∞–Ω —Å—Ç—Ä–æ–∫–æ–π, –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Ñ–æ—Ä–º–∞—Ç—É UUID.
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400 + –æ—à–∏–±–∫–∞ –ø–æ identifierType.
        "not-a-uuid",
        #https://app.testiny.io/p/1/testcases/tcf/42/tc/68
        # –°—Ü–µ–Ω–∞—Ä–∏–π: identifierType –∏–º–µ–µ—Ç —Ñ–æ—Ä–º—É UUID, –Ω–æ —Ç–∞–∫–æ–≥–æ —Ç–∏–ø–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Å–∏—Å—Ç–µ–º–µ.
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400 + –æ—à–∏–±–∫–∞ –ø–æ identifierType (—Å—Å—ã–ª–∫–∞ –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ä–µ—Å—É—Ä—Å).
        "zzzzzzzz-zzzz-zzzz-zzzz-zzzzzzzzzzzz",
        #https://app.testiny.io/p/1/testcases/tcf/42/tc/69
        # –°—Ü–µ–Ω–∞—Ä–∏–π: identifierType –ø–µ—Ä–µ–¥–∞–Ω –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ —Ç–∏–ø–∞ (—á–∏—Å–ª–æ –≤–º–µ—Å—Ç–æ —Å—Ç—Ä–æ–∫–∏/UUID).
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400 + –æ—à–∏–±–∫–∞ –ø–æ identifierType.
        123456,
    ],
)
def test_create_patient_with_invalid_identifier_type(invalid_identifier_type):
    """
    –û–±—â–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π:
    –°–æ–∑–¥–∞—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞ –ø–æ API /patient —Å —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω–æ–π Person,
    —Å –≤–∞–ª–∏–¥–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º identifier (patient_identifier),
    –Ω–æ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –ù–ï–≤–∞–ª–∏–¥–Ω—ã–π identifierType.

    –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
    - OpenMRS –ù–ï —Å–æ–∑–¥–∞—ë—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTTP 400.
    - –í —Ç–µ–∫—Å—Ç–µ –æ—Ç–≤–µ—Ç–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ identifierType / identifier type.
    """
    # –ë–µ—Ä—ë–º –≤–∞–ª–∏–¥–Ω—ã–π —Ç–∏–ø "OpenMRS ID" –∏ –≤–∞–ª–∏–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ identifier.
    # –í —ç—Ç–æ–º —Ç–µ—Å—Ç–µ –≤–∞–ª–∏–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ identifier –º—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º,
    # –∞ –ª–æ–º–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª–µ identifierType.
    valid_identifier_type, valid_patient_identifier = get_openmrs_id_identifier()

    # –ë–µ—Ä—ë–º —Å–ª—É—á–∞–π–Ω—É—é –≤–∞–ª–∏–¥–Ω—É—é –ª–æ–∫–∞—Ü–∏—é (–≤ OpenMRS identifier –æ–±—ã—á–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ location)
    location = get_random_valid_location()

    # –°–æ–∑–¥–∞—ë–º –≤–∞–ª–∏–¥–Ω—É—é Person –∑–∞—Ä–∞–Ω–µ–µ
    person = create_valid_person()

    # –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞ —Å –ù–ï–≤–∞–ª–∏–¥–Ω—ã–º identifierType
    response = create_in_valid_patient_with_person(
        username="admin",
        password="Admin123",
        location=location,
        identifier_type=invalid_identifier_type,
        patient_identifier=valid_patient_identifier,
        person=person,
    )

    # –û–∂–∏–¥–∞–µ–º –æ—Ç–∫–∞–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ OpenMRS
    assert response.status_code == 400

    # –û–∂–∏–¥–∞–µ–º, —á—Ç–æ API –≤–µ—Ä–Ω—ë—Ç –æ—à–∏–±–∫—É –∏–º–µ–Ω–Ω–æ –∏–∑-–∑–∞ –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ identifierType
    assert ("identifierType" in response.text) or ("identifier type" in response.text.lower())


====================================================================================================
MODULE: tests.new_patient.test_create_patient_with_new_person
PATH:   tests/new_patient/test_create_patient_with_new_person.py
====================================================================================================

# tests/test_create_patient_with_new_person_validation.py

import pytest
import requests
from requests.auth import HTTPBasicAuth
from faker import Faker

from request_modules.locations.get_random_valid_location import get_random_valid_location
from request_modules.patientidentifiertype.get_random_valid_patient_identifier_type import (
    get_openmrs_id_identifier,
)

fake = Faker("ru_RU")

BASE_URL = "http://localhost/openmrs/ws/rest/v1"
USERNAME = "admin"
PASSWORD = "Admin123"


# ============================================================
# helpers
# ============================================================

def build_valid_person_dict() -> dict:
    # –°—Ü–µ–Ω–∞—Ä–∏–π: —Ñ–æ—Ä–º–∏—Ä—É–µ–º –≤–∞–ª–∏–¥–Ω—ã–π –æ–±—ä–µ–∫—Ç Person –¥–ª—è –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è (POST /patient).
    # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å–ª–æ–≤–∞—Ä—å person —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ names/gender/birthdate.
    return {
        "names": [
            {
                "givenName": fake.first_name_male(),
                "familyName": fake.last_name(),
            }
        ],
        "gender": "M",
        "birthdate": fake.date_of_birth(minimum_age=18, maximum_age=80).isoformat(),
        # addresses –æ–±—ã—á–Ω–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –≤ OpenMRS
        # –µ—Å–ª–∏ –≤ –≤–∞—à–µ–º –∏–Ω—Å—Ç–∞–Ω—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã ‚Äî –¥–æ–±–∞–≤—å—Ç–µ —Å—é–¥–∞
    }


def build_valid_patient_payload_dict() -> dict:
    # –°—Ü–µ–Ω–∞—Ä–∏–π: —Ñ–æ—Ä–º–∏—Ä—É–µ–º –≤–∞–ª–∏–¥–Ω—ã–π payload –¥–ª—è POST /patient (—Å–æ–∑–¥–∞—ë–º –∏ patient, –∏ person –≤–º–µ—Å—Ç–µ).
    # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: payload —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ person + identifiers (—Å –≤–∞–ª–∏–¥–Ω—ã–º–∏ type/value/location).
    location_uuid = get_random_valid_location()["uuid"]
    identifier_type_uuid, identifier_value = get_openmrs_id_identifier()

    return {
        "person": build_valid_person_dict(),
        "identifiers": [
            {
                "identifier": identifier_value,
                "identifierType": identifier_type_uuid,
                "location": location_uuid,
                "preferred": True,
            }
        ],
    }


def post_patient(payload: dict) -> requests.Response:
    # –°—Ü–µ–Ω–∞—Ä–∏–π: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º POST /patient —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º payload.
    # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –ø–æ–ª—É—á–∞–µ–º Response –æ—Ç OpenMRS (—É—Å–ø–µ—Ö –∏–ª–∏ –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏).
    return requests.post(
        f"{BASE_URL}/patient",
        json=payload,
        auth=HTTPBasicAuth(USERNAME, PASSWORD),
        headers={
            "Accept": "application/json",
            "Content-Type": "application/json",
        },
        timeout=30,
    )


# ============================================================
# Create new person validation
# ============================================================

@pytest.mark.parametrize(
    "person_value, description",
    [
        #https://app.testiny.io/p/1/testcases/tcf/44/tc/78
        # –°—Ü–µ–Ω–∞—Ä–∏–π: –ø–æ–ª–µ person –ø–µ—Ä–µ–¥–∞–Ω–æ –∫–∞–∫ null.
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400 –∏–ª–∏ 500, –≤ —Ç–µ–∫—Å—Ç–µ –æ—à–∏–±–∫–∏ –µ—Å—Ç—å person/null.
        (None, "person is null"),
        #https://app.testiny.io/p/1/testcases/tcf/44/tc/79
        # –°—Ü–µ–Ω–∞—Ä–∏–π: –ø–æ–ª–µ person –ø–µ—Ä–µ–¥–∞–Ω–æ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π (–Ω–µ –æ–±—ä–µ–∫—Ç).
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400 –∏–ª–∏ 500.
        ("", "person is empty string"),
        #https://app.testiny.io/p/1/testcases/tcf/44/tc/80
        # –°—Ü–µ–Ω–∞—Ä–∏–π: –ø–æ–ª–µ person –ø–µ—Ä–µ–¥–∞–Ω–æ —Å—Ç—Ä–æ–∫–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä uuid-like), –Ω–æ –º—ã –æ–∂–∏–¥–∞–µ–º –æ–±—ä–µ–∫—Ç person –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏.
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400 –∏–ª–∏ 500.
        ("uuid-like-string", "person is string instead of object"),

    ],
)
def test_create_patient_with_invalid_person_root(person_value, description):
    # –°—Ü–µ–Ω–∞—Ä–∏–π: –±–µ—Ä—ë–º –≤–∞–ª–∏–¥–Ω—ã–π payload –∏ –ø–æ—Ä—Ç–∏–º –ø–æ–ª–µ person –æ–¥–Ω–∏–º –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—ã—à–µ.
    # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: OpenMRS –Ω–µ —Å–æ–∑–¥–∞—ë—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞ (–æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏).
    payload = build_valid_patient_payload_dict()

    if person_value == "__MISSING__":
        payload.pop("person", None)
    else:
        payload["person"] = person_value

    response = post_patient(payload)

    assert response.status_code in (400, 500), (
        f"{description}\n"
        f"Response body: {(response.text or '')[:2000]}"
    )
    assert "person" in (response.text or "").lower() or "null" in (response.text or "").lower()


# ============================================================
# 2) person.names validation
# ============================================================

@pytest.mark.parametrize(
    "invalid_names",
    [   # https://app.testiny.io/p/1/testcases/tcf/45/tc/81
        # –°—Ü–µ–Ω–∞—Ä–∏–π: person.names = null.
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400 (–≤–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –∏–º—ë–Ω).
        None,
        # https://app.testiny.io/p/1/testcases/tcf/45/tc/82
        # –°—Ü–µ–Ω–∞—Ä–∏–π: person.names = "" (–Ω–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø).
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400.
        "",
        # https://app.testiny.io/p/1/testcases/tcf/45/tc/83
        # –°—Ü–µ–Ω–∞—Ä–∏–π: person.names = {} (–Ω–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø ‚Äî –æ–±—ä–µ–∫—Ç –≤–º–µ—Å—Ç–æ —Å–ø–∏—Å–∫–∞).
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400.
        {},
        # https://app.testiny.io/p/1/testcases/tcf/45/tc/84
        # –°—Ü–µ–Ω–∞—Ä–∏–π: person.names = [] (–ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –∏–º—ë–Ω).
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400.
        [],
        # https://app.testiny.io/p/1/testcases/tcf/45/tc/85
        # –°—Ü–µ–Ω–∞—Ä–∏–π: –≤ names[0] –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç givenName.
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400 (givenName –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω).
        [{"familyName": "X"}],

        # https://app.testiny.io/p/1/testcases/tcf/45/tc/86
        # –°—Ü–µ–Ω–∞—Ä–∏–π: givenName –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞.
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400.
        [{"givenName": "", "familyName": "X"}],
        # https://app.testiny.io/p/1/testcases/tcf/45/tc/87
        # –°—Ü–µ–Ω–∞—Ä–∏–π: —ç–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ names –Ω–µ –æ–±—ä–µ–∫—Ç (–Ω–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø).
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400.
        [123],
    ],
)
def test_create_patient_with_invalid_person_names(invalid_names):
    # –°—Ü–µ–Ω–∞—Ä–∏–π: —Å–æ–∑–¥–∞—ë–º –≤–∞–ª–∏–¥–Ω—ã–π payload –∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π person.names.
    # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: OpenMRS –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å ‚Üí HTTP 400.
    payload = build_valid_patient_payload_dict()
    payload["person"]["names"] = invalid_names

    response = post_patient(payload)

    assert response.status_code == 400, (
        f"invalid_names={invalid_names!r}\n"
        f"Response body: {(response.text or '')[:2000]}"
    )
    assert any(
        key in (response.text or "").lower()
        for key in ["name", "names", "person"]
    )


# ============================================================
# 2b) person.names –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ –∫–µ–π—Å—ã (familyName –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—É—Å—Ç—ã–º/–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º)
# ============================================================

@pytest.mark.parametrize(
    "names_payload",
    [   #https://app.testiny.io/p/1/testcases/tcf/45/tc/88/
        # –°—Ü–µ–Ω–∞—Ä–∏–π: —É–∫–∞–∑–∞–Ω —Ç–æ–ª—å–∫–æ givenName, familyName –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –ø–∞—Ü–∏–µ–Ω—Ç —Å–æ–∑–¥–∞—ë—Ç—Å—è —É—Å–ø–µ—à–Ω–æ (HTTP 200/201),
        # —Ç–∞–∫ –∫–∞–∫ –≤ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ familyName —Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º.
        [{"givenName": "X"}],

        #https://app.testiny.io/p/1/testcases/tcf/45/tc/89
        # –°—Ü–µ–Ω–∞—Ä–∏–π: familyName –∑–∞–¥–∞–Ω –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π.
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –ø–∞—Ü–∏–µ–Ω—Ç —Å–æ–∑–¥–∞—ë—Ç—Å—è —É—Å–ø–µ—à–Ω–æ (HTTP 200/201),
        # —Ç–∞–∫ –∫–∞–∫ —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç familyName –∫–∞–∫ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π/–Ω–µ–ø—É—Å—Ç–æ–π.
        [{"givenName": "X", "familyName": ""}],
    ],
)
def test_create_patient_with_person_names_familyname_optional_positive(names_payload):
    # –°—Ü–µ–Ω–∞—Ä–∏–π: –ø–æ–¥–º–µ–Ω—è–µ–º person.names –Ω–∞ ‚Äú–ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π‚Äù –∫–µ–π—Å, –≥–¥–µ familyName –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω.
    # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞.
    payload = build_valid_patient_payload_dict()
    payload["person"]["names"] = names_payload

    response = post_patient(payload)

    assert response.status_code in (200, 201), (
        f"names_payload={names_payload!r}\n"
        f"Response body: {(response.text or '')[:2000]}"
    )

    # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –≤ –æ—Ç–≤–µ—Ç–µ –µ—Å—Ç—å –±–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ Patient.
    data = response.json()
    assert isinstance(data, dict)
    assert "uuid" in data and isinstance(data["uuid"], str)
    assert data.get("voided") is False
    assert isinstance(data.get("person"), dict)


# ============================================================
# 3) person.gender validation (type/empty)
# ============================================================

@pytest.mark.parametrize(
    "invalid_gender",
    [
        #https://app.testiny.io/p/1/testcases/tcf/45/tc/90
        # –°—Ü–µ–Ω–∞—Ä–∏–π: gender = null.
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400 (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ).
        None,
        #https://app.testiny.io/p/1/testcases/tcf/45/tc/91
        # –°—Ü–µ–Ω–∞—Ä–∏–π: gender = "" (–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞).
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400.
        "",
        #https://app.testiny.io/p/1/testcases/tcf/45/tc/92
        # –°—Ü–µ–Ω–∞—Ä–∏–π: gender –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ —Ç–∏–ø–∞ (—á–∏—Å–ª–æ).
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400.
        123,
    ],
)
def test_create_patient_with_invalid_gender(invalid_gender):
    # –°—Ü–µ–Ω–∞—Ä–∏–π: –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π gender (–ø—É—Å—Ç–æ/–Ω–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø).
    # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: OpenMRS –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å ‚Üí HTTP 400.
    payload = build_valid_patient_payload_dict()
    payload["person"]["gender"] = invalid_gender

    response = post_patient(payload)

    assert response.status_code == 400, (
        f"invalid_gender={invalid_gender!r}\n"
        f"Response body: {(response.text or '')[:2000]}"
    )
    assert any(
        key in (response.text or "").lower()
        for key in ["gender", "person"]
    )


# ============================================================
# 3b) person.gender custom values ‚Äî POSITIVE (—Å–µ–π—á–∞—Å —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ –¥–æ–ª–∂–Ω–æ)
# ============================================================

@pytest.mark.parametrize(
    "gender_value",
    [
        #https://app.testiny.io/p/1/testcases/tcf/45/tc/93
        # –°—Ü–µ–Ω–∞—Ä–∏–π: gender = "X" (–Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ).
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –ø–∞—Ü–∏–µ–Ω—Ç —Å–æ–∑–¥–∞—ë—Ç—Å—è —É—Å–ø–µ—à–Ω–æ (HTTP 200/201),
        # —Ç–∞–∫ –∫–∞–∫ –≤ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ gender –Ω–µ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–æ –ø–æ enum M/F/U.
        "X",
        #https://app.testiny.io/p/1/testcases/tcf/45/tc/94
        # –°—Ü–µ–Ω–∞—Ä–∏–π: gender = "M" (–Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ).
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –ø–∞—Ü–∏–µ–Ω—Ç —Å–æ–∑–¥–∞—ë—Ç—Å—è —É—Å–ø–µ—à–Ω–æ (HTTP 200/201),
        # —Ç–∞–∫ –∫–∞–∫ –≤ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ gender –Ω–µ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–æ –ø–æ enum M/F/U.
        "M",
        #https://app.testiny.io/p/1/testcases/tcf/45/tc/95
        # –°—Ü–µ–Ω–∞—Ä–∏–π: gender = "F" .
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –ø–∞—Ü–∏–µ–Ω—Ç —Å–æ–∑–¥–∞—ë—Ç—Å—è —É—Å–ø–µ—à–Ω–æ (HTTP 200/201),
        # —Ç–∞–∫ –∫–∞–∫ –≤ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ gender –Ω–µ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–æ –ø–æ enum M/F/U.
        "F",
        #https://app.testiny.io/p/1/testcases/tcf/45/tc/96
        # –°—Ü–µ–Ω–∞—Ä–∏–π: gender = "U"
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –ø–∞—Ü–∏–µ–Ω—Ç —Å–æ–∑–¥–∞—ë—Ç—Å—è —É—Å–ø–µ—à–Ω–æ (HTTP 200/201),
        # —Ç–∞–∫ –∫–∞–∫ –≤ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ gender –Ω–µ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–æ –ø–æ enum M/F/U.
        "U",
        #https://app.testiny.io/p/1/testcases/tcf/45/tc/97
        # –°—Ü–µ–Ω–∞—Ä–∏–π: gender = "male" (–Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å—Ç—Ä–æ–∫–∞).
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –ø–∞—Ü–∏–µ–Ω—Ç —Å–æ–∑–¥–∞—ë—Ç—Å—è —É—Å–ø–µ—à–Ω–æ (HTTP 200/201),
        # —Ç–∞–∫ –∫–∞–∫ –≤ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ gender –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏.
        "male",
    ],
)
def test_create_patient_with_custom_gender_positive(gender_value):
    # –°—Ü–µ–Ω–∞—Ä–∏–π: –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π gender, –∫–æ—Ç–æ—Ä—ã–π —Å–∏—Å—Ç–µ–º–∞ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç.
    # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞.
    payload = build_valid_patient_payload_dict()
    payload["person"]["gender"] = gender_value

    response = post_patient(payload)

    assert response.status_code in (200, 201), (
        f"gender_value={gender_value!r}\n"
        f"Response body: {(response.text or '')[:2000]}"
    )

    # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –≤ –æ—Ç–≤–µ—Ç–µ –µ—Å—Ç—å –±–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ Patient.
    data = response.json()
    assert isinstance(data, dict)
    assert "uuid" in data and isinstance(data["uuid"], str)
    assert data.get("voided") is False
    assert isinstance(data.get("person"), dict)

    # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –µ—Å–ª–∏ gender –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ ‚Äî –æ–Ω —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º.
    returned_gender = (data.get("person") or {}).get("gender")
    if returned_gender is not None:
        assert returned_gender == gender_value


# ============================================================
# 4) person.birthdate validation ‚Äî NEGATIVE
# ============================================================

@pytest.mark.parametrize(
    "invalid_birthdate",
    [
        #https://app.testiny.io/p/1/testcases/tcf/45/tc/98
        # –°—Ü–µ–Ω–∞—Ä–∏–π: birthdate = None .
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400.
        None,
        #https://app.testiny.io/p/1/testcases/tcf/45/tc/99
        # –°—Ü–µ–Ω–∞—Ä–∏–π: birthdate = "" (–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞).
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400.
        "",
        #https://app.testiny.io/p/1/testcases/tcf/45/tc/100
        # –°—Ü–µ–Ω–∞—Ä–∏–π: birthdate –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (–Ω–µ ISO YYYY-MM-DD).
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400.
        "31-12-1990",
        #https://app.testiny.io/p/1/testcases/tcf/45/tc/101
        # –°—Ü–µ–Ω–∞—Ä–∏–π: birthdate ‚Äî –Ω–µ –¥–∞—Ç–∞.
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400.
        "not-a-date",
        #https://app.testiny.io/p/1/testcases/tcf/45/tc/102
        # –°—Ü–µ–Ω–∞—Ä–∏–π: birthdate –≤ –±—É–¥—É—â–µ–º.
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400 (–æ–±—ã—á–Ω–æ –∑–∞–ø—Ä–µ—â–µ–Ω–æ).
        "3000-01-01",
        #https://app.testiny.io/p/1/testcases/tcf/45/tc/103
        # –°—Ü–µ–Ω–∞—Ä–∏–π: birthdate –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ —Ç–∏–ø–∞ (—á–∏—Å–ª–æ).
        # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: HTTP 400.
        12345,
    ],
)
def test_create_patient_with_invalid_birthdate(invalid_birthdate):
    # –°—Ü–µ–Ω–∞—Ä–∏–π: –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π birthdate.
    # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: OpenMRS –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å ‚Üí HTTP 400.
    payload = build_valid_patient_payload_dict()
    payload["person"]["birthdate"] = invalid_birthdate

    response = post_patient(payload)

    assert response.status_code == 400, (
        f"invalid_birthdate={invalid_birthdate!r}\n"
        f"Response body: {(response.text or '')[:2000]}"
    )
    assert any(
        key in (response.text or "").lower()
        for key in ["birthdate", "date", "person"]
    )


# ============================================================
# 4b) person.birthdate = null ‚Äî POSITIVE
# ============================================================

def test_create_patient_with_null_birthdate_positive():
    # –°—Ü–µ–Ω–∞—Ä–∏–π: birthdate –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∫–∞–∫ null.
    # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –ø–∞—Ü–∏–µ–Ω—Ç —Å–æ–∑–¥–∞—ë—Ç—Å—è —É—Å–ø–µ—à–Ω–æ (HTTP 200/201),
    # —Ç–∞–∫ –∫–∞–∫ –≤ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ birthdate –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π (null).
    payload = build_valid_patient_payload_dict()
    payload["person"]["birthdate"] = None

    response = post_patient(payload)

    assert response.status_code in (200, 201), (
        "birthdate=None\n"
        f"Response body: {(response.text or '')[:2000]}"
    )

    # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –≤ –æ—Ç–≤–µ—Ç–µ –µ—Å—Ç—å –±–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ Patient.
    data = response.json()
    assert isinstance(data, dict)
    assert "uuid" in data and isinstance(data["uuid"], str)
    assert data.get("voided") is False

    # –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: birthdate –ª–∏–±–æ null, –ª–∏–±–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç/–ø—É—Å—Ç–æ–µ –≤ –æ—Ç–≤–µ—Ç–µ (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç representation).
    returned_birthdate = (data.get("person") or {}).get("birthdate")
    assert returned_birthdate in (None, "")


====================================================================================================
MODULE: tests.visit.test_create_visit
PATH:   tests/visit/test_create_visit.py
====================================================================================================

# tests/test_create_visit.py

from __future__ import annotations

from datetime import datetime, timezone
import uuid
import pytest
import requests
from requests.auth import HTTPBasicAuth

from checks.visit_checks import assert_valid_visit_response

from request_modules.create_random_valid_person import create_valid_person
from request_modules.create_valid_patient_with_person import create_valid_patient_with_person
from request_modules.locations.get_random_valid_location import get_random_valid_location
from request_modules.patientidentifiertype.get_random_valid_patient_identifier_type import get_openmrs_id_identifier
from request_modules.visittype.get_random_valid_visit_type import get_random_valid_visit_type
from request_modules.visit.create_visit import create_visit, fetch_visit_full


USERNAME = "admin"
PASSWORD = "Admin123"


def iso_utc_now() -> str:
    # –ø—Ä–∏–º–µ—Ä –≤ –¥–æ–∫–∞—Ö: 2016-10-08T04:09:25.000Z
    # –¥–µ–ª–∞–µ–º ISO8601 —Å –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞–º–∏ –∏ Z
    now = datetime.now(timezone.utc)
    return now.strftime("%Y-%m-%dT%H:%M:%S.000Z")


#TODO: NEED WORK!
#TODO: CREATE USERS FOR DEMO

@pytest.fixture()
def patient_context() -> dict:
    # 1) —Å–æ–∑–¥–∞—ë–º Person
    person = create_valid_person()

    # 2) –±–µ—Ä—ë–º –ª–æ–∫–∞—Ü–∏—é
    location = get_random_valid_location()
    location_uuid = location["uuid"]

    # 3) –±–µ—Ä—ë–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π OpenMRS ID —Ç–∏–ø + –∑–Ω–∞—á–µ–Ω–∏–µ (LuhnMod30)
    identifier_type_uuid, identifier_value = get_openmrs_id_identifier()

    # 4) —Å–æ–∑–¥–∞—ë–º Patient –Ω–∞ –±–∞–∑–µ person
    patient_json = create_valid_patient_with_person(
        username=USERNAME,
        password=PASSWORD,
        person=person,
        location=location_uuid,
        identifier_type=identifier_type_uuid,
        patient_identifier=identifier_value,
    )

    return {
        "patient_uuid": patient_json["uuid"],
        "location_uuid": location_uuid,
    }


@pytest.fixture()
def visit_type_uuid() -> str:
    return get_random_valid_visit_type()["uuid"]

#TODO: –≤—Å–µ –≤–∞–ª–∏–¥–Ω—ã–µ —Ç–∏–ø—ã –ø–æ–ª–µ–π
#TODO: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–æ–ª–∏
def test_create_visit_success(patient_context: dict, visit_type_uuid: str):
    patient_uuid = patient_context["patient_uuid"]
    location_uuid = patient_context["location_uuid"]

    resp = create_visit(
        username=USERNAME,
        password=PASSWORD,
        patient_uuid=patient_uuid,
        visit_type_uuid=visit_type_uuid,
        start_datetime_iso=iso_utc_now(),
        location_uuid=location_uuid,
    )

    assert resp.status_code == 201, resp.text
    visit = resp.json()

    assert_valid_visit_response(
        visit,
        patient_uuid=patient_uuid,
        visit_type_uuid=visit_type_uuid,
        location_uuid=location_uuid,
    )

    # –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: GET full –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
    full = fetch_visit_full(username=USERNAME, password=PASSWORD, visit_uuid=visit["uuid"])
    assert_valid_visit_response(
        full,
        patient_uuid=patient_uuid,
        visit_type_uuid=visit_type_uuid,
        location_uuid=location_uuid,
    )


@pytest.mark.parametrize(
    "mutator",
    [
        lambda p: {k: v for k, v in p.items() if k != "patient"},
        lambda p: {k: v for k, v in p.items() if k != "visitType"},
        lambda p: {k: v for k, v in p.items() if k != "startDatetime"},
    ],
)
def test_create_visit_missing_required_fields_returns_400(patient_context: dict, visit_type_uuid: str, mutator):
    """
    –í REST –¥–æ–∫–∞—Ö patient –∏ visitType –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ Required,
    –∞ startDatetime ‚Äî core-required –¥–ª—è Visit (—Å–º. Visit constructor).
    :contentReference[oaicite:2]{index=2}
    """
    patient_uuid = patient_context["patient_uuid"]
    location_uuid = patient_context["location_uuid"]

    payload = {
        "patient": patient_uuid,
        "visitType": visit_type_uuid,
        "startDatetime": iso_utc_now(),
        "location": location_uuid,
    }

    bad_payload = mutator(payload)



    resp = requests.post(
        "http://localhost/openmrs/ws/rest/v1/visit",
        json=bad_payload,
        auth=HTTPBasicAuth(USERNAME, PASSWORD),
        headers={"Accept": "application/json", "Content-Type": "application/json"},
        timeout=30,
    )

    assert resp.status_code == 400, resp.text


def test_create_visit_invalid_patient_uuid_returns_400_or_404(visit_type_uuid: str):
    """
    –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–µ—Ä—Å–∏–∏/–≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–µ—Å—É—Ä—Å –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å 400 (bad ref) –∏–ª–∏ 404.
    """
    fake_patient_uuid = str(uuid.uuid4())

    location_uuid = get_random_valid_location()["uuid"]
    resp = create_visit(
        username=USERNAME,
        password=PASSWORD,
        patient_uuid=fake_patient_uuid,
        visit_type_uuid=visit_type_uuid,
        start_datetime_iso=iso_utc_now(),
        location_uuid=location_uuid,
    )

    assert resp.status_code in (400, 404), resp.text


def test_create_visit_unauthorized_returns_401(patient_context: dict, visit_type_uuid: str):
    patient_uuid = patient_context["patient_uuid"]
    location_uuid = patient_context["location_uuid"]

    resp = create_visit(
        username=USERNAME,
        password="WRONG_PASSWORD",
        patient_uuid=patient_uuid,
        visit_type_uuid=visit_type_uuid,
        start_datetime_iso=iso_utc_now(),
        location_uuid=location_uuid,
    )

    assert resp.status_code == 401, resp.text


====================================================================================================
MODULE: user.create_all_users_with_all_roles
PATH:   user/create_all_users_with_all_roles.py
====================================================================================================

import requests
from requests.auth import HTTPBasicAuth

BASE_URL = "http://localhost/openmrs/ws/rest/v1"
auth = HTTPBasicAuth("admin", "Admin123")

ROLE_UUIDS = [
    "246f8412-01fb-4e55-86d7-6441cd1b81a5",
    "a142aa96-772a-4d09-b80c-b3a78687b189",
    "d8ddab2c-20a5-4a3c-b209-856c7fe839cd",
    "7f04f24c-e433-4bc7-95cd-975b6f003207",
    "66fa1ec4-5d30-4127-a693-d8b1f9519a14",
    "9873dba9-484f-42c2-a98d-f224bd65117a",
    "dc978fe8-b574-4e11-be54-626ae2d28ed8",
    "eba658df-fa88-4dab-b000-57e1e5cb2e43",
    "fb393086-d6ec-4bcb-a300-5815a554c4ae",
    "2d09a0e2-240a-4dd7-9c3e-9e2cd2cb2d1f",
    "58f60da3-03bd-4b57-bb3c-429b50f6939b",
    "564b560e-3fe8-4829-8be4-68ddb40cf106",
    "93a9c2f8-9296-488f-9451-43667e1c4d7f",
    "f7fd42ef-880e-40c5-972d-e4ae7c990de2",
    "2083fd40-3391-11ed-a667-507b9dea1806",
    "d210eb66-2188-11ed-9dff-507b9dea1806",
    "84bdd876-4694-11ed-8109-00155dcc3fc0",
    "cca4be4b-2188-11ed-9dff-507b9dea1806",
    "8ee2f2ac-467f-11ed-8109-00155dcc3fc0",
    "a49be648-6b0a-11ed-93a2-806d973f13a9",
    "4ef1f0f9-fee6-414b-910d-28e17df345c2",
    "2749cd1b-251a-4d8b-bc35-0165f2b1af3e",
    "fab43ac4-79bc-4f3d-805b-bd3a82ce41e9",
    "2f087f90-9c47-4262-bfce-23c7862e727e",
    "ab2160f6-0941-430c-9752-6714353fbd3c",
    "f089471c-e00b-468e-96e8-46aea1b339af",
    "8d94f280-c2cc-11de-8d13-0010c6dffd0f",
    "7d8d214d-2188-11ed-9dff-507b9dea1806",
    "8d94f852-c2cc-11de-8d13-0010c6dffd0f",
]

START_USER = 200  # user100


def create_user(user_number: int, role_uuid: str):
    payload = {
        "username": f"user{user_number}",
        "password": "Password123",
        "systemId": str(user_number),
        "person": {
            "names": [{"givenName": f"Demo{user_number}", "familyName": "User"}],
            "gender": "M",
            "birthdate": "1997-09-02",
        },
        # ‚úÖ –†–û–í–ù–û –û–î–ù–ê –†–û–õ–¨ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        "roles": [{"uuid": role_uuid}],
    }

    r = requests.post(
        f"{BASE_URL}/user",
        json=payload,
        headers={"Accept": "application/json", "Content-Type": "application/json"},
        auth=auth,
        timeout=30,
    )

    print(f"user{user_number} (role {role_uuid}) -> status {r.status_code}")
    if r.status_code == 409:
        print("User already exists, skipping.\n")
        return

    print(r.text)
    r.raise_for_status()
    print()


if __name__ == "__main__":
    for i, role_uuid in enumerate(ROLE_UUIDS):
        user_number = START_USER + i
        create_user(user_number, role_uuid)


====================================================================================================
MODULE: user.delete_user
PATH:   user/delete_user.py
====================================================================================================

import requests
from requests.auth import HTTPBasicAuth

BASE_URL = "http://localhost/openmrs/ws/rest/v1"
auth = HTTPBasicAuth("admin", "Admin123")

HEADERS = {
    "Accept": "application/json",
    "Content-Type": "application/json",
}


def get_user_uuid(username: str) -> str | None:
    """–ü–æ–ª—É—á–∏—Ç—å UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ username"""
    r = requests.get(
        f"{BASE_URL}/user",
        params={"q": username},
        headers=HEADERS,
        auth=auth,
        timeout=30,
    )
    r.raise_for_status()

    results = r.json().get("results", [])
    if not results:
        return None

    return results[0]["uuid"]


def delete_user(username: str):
    user_uuid = get_user_uuid(username)

    if not user_uuid:
        print(f"‚ùå User '{username}' not found")
        return

    r = requests.delete(
        f"{BASE_URL}/user/{user_uuid}",
        headers=HEADERS,
        auth=auth,
        timeout=30,
    )

    if r.status_code in (200, 204):
        print(f"‚úÖ User '{username}' deleted")
    else:
        print(f"‚ö†Ô∏è Failed to delete '{username}': {r.status_code}")
        print(r.text)


if __name__ == "__main__":
    delete_user("user11")


====================================================================================================
MODULE: user.get_active_users
PATH:   user/get_active_users.py
====================================================================================================

import requests
from requests.auth import HTTPBasicAuth

BASE_URL = "http://localhost/openmrs/ws/rest/v1"
USERNAME = "admin"
PASSWORD = "Admin123"


def get_active_users():
    url = f"{BASE_URL}/user"
    params = {
        "retired": "false",
        "v": "full",   # —Ä–æ–ª–∏ –∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ —Ç—É—Ç
        "limit": 100,
    }

    r = requests.get(
        url,
        params=params,
        auth=HTTPBasicAuth(USERNAME, PASSWORD),
        headers={"Accept": "application/json"},
        timeout=10,
    )

    if not r.ok:
        print("HTTP:", r.status_code)
        print("URL :", r.url)
        print("BODY:", (r.text or "")[:2000])
        r.raise_for_status()

    return r.json().get("results", [])


def extract_roles(user):
    roles = user.get("roles", [])
    return ", ".join(
        role.get("display", role.get("name", "-")) for role in roles
    ) or "-"


def extract_privileges(user):
    privileges = set()

    for role in user.get("roles", []):
        for priv in role.get("privileges", []):
            name = priv.get("display") or priv.get("name")
            if name:
                privileges.add(name)

    return ", ".join(sorted(privileges)) or "-"


def print_table(users):
    headers = ["Username", "Person", "Roles", "Privileges", "UUID", "Retired"]
    rows = []

    for user in users:
        person = user.get("person") or {}
        rows.append([
            user.get("username", "-"),
            person.get("display", "-"),
            extract_roles(user),
            extract_privileges(user),
            user.get("uuid", "-"),
            str(user.get("retired", "-")),
        ])

    col_widths = [
        max(len(str(row[i])) for row in ([headers] + rows))
        for i in range(len(headers))
    ]

    def format_row(row):
        return " | ".join(
            str(cell).ljust(col_widths[i]) for i, cell in enumerate(row)
        )

    separator = "-+-".join("-" * w for w in col_widths)

    print(f"\n–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: {len(rows)}\n")
    print(format_row(headers))
    print(separator)

    for row in rows:
        print(format_row(row))


if __name__ == "__main__":
    users = get_active_users()
    print_table(users)


====================================================================================================
MODULE: user.get_retied_user_with_add_patient
PATH:   user/get_retied_user_with_add_patient.py
====================================================================================================

import requests
from requests.auth import HTTPBasicAuth

#TODO: –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –≤–æ
BASE_URL = "http://localhost/openmrs/ws/rest/v1"
USERNAME = "admin"
PASSWORD = "Admin123"

TARGET_PRIVILEGE = "Add Patients"


def get_retired_users(limit=100):
    url = f"{BASE_URL}/user"
    params = {
        "retired": "true",
        "v": "full",
        "limit": limit,
    }

    r = requests.get(
        url,
        params=params,
        auth=HTTPBasicAuth(USERNAME, PASSWORD),
        headers={"Accept": "application/json"},
        timeout=10,
    )

    if not r.ok:
        print("HTTP:", r.status_code)
        print("URL :", r.url)
        print("BODY:", (r.text or "")[:2000])
        r.raise_for_status()

    return r.json().get("results", [])


def privilege_name(priv: dict) -> str:
    return priv.get("display") or priv.get("name") or ""


def role_name(role: dict) -> str:
    return role.get("display") or role.get("name") or "-"


def has_privilege(user: dict, target_priv: str) -> bool:
    for role in user.get("roles", []):
        for priv in role.get("privileges", []):
            if privilege_name(priv) == target_priv:
                return True
    return False


def roles_granting_privilege(user: dict, target_priv: str) -> str:
    granting = []
    for role in user.get("roles", []):
        role_privs = {
            privilege_name(p)
            for p in role.get("privileges", [])
            if privilege_name(p)
        }
        if target_priv in role_privs:
            granting.append(role_name(role))
    return ", ".join(granting) or "-"


def print_table(users):
    headers = ["Username", "Person", "Roles", "Granting roles", "User UUID", "Retired"]
    rows = []

    for user in users:
        if not has_privilege(user, TARGET_PRIVILEGE):
            continue

        person = user.get("person") or {}
        roles = ", ".join(role_name(r) for r in user.get("roles", [])) or "-"

        rows.append([
            user.get("username", "-"),
            person.get("display", "-"),
            roles,
            roles_granting_privilege(user, TARGET_PRIVILEGE),
            user.get("uuid", "-"),      # ‚Üê –Ø–í–ù–û user UUID
            str(user.get("retired", "-")),
        ])

    if not rows:
        print(f"\nRetired –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–∏–≤–∏–ª–µ–≥–∏–µ–π '{TARGET_PRIVILEGE}' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.\n")
        return

    col_widths = [
        max(len(str(row[i])) for row in ([headers] + rows))
        for i in range(len(headers))
    ]

    def format_row(row):
        return " | ".join(str(cell).ljust(col_widths[i]) for i, cell in enumerate(row))

    separator = "-+-".join("-" * w for w in col_widths)

    print(f"\nRetired –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –° –ø—Ä–∏–≤–∏–ª–µ–≥–∏–µ–π '{TARGET_PRIVILEGE}': {len(rows)}\n")
    print(format_row(headers))
    print(separator)

    for row in rows:
        print(format_row(row))


if __name__ == "__main__":
    users = get_retired_users(limit=100)
    print_table(users)


====================================================================================================
MODULE: user.get_retiered_users
PATH:   user/get_retiered_users.py
====================================================================================================

import requests
from requests.auth import HTTPBasicAuth

BASE_URL = "http://localhost/openmrs/ws/rest/v1"
USERNAME = "admin"
PASSWORD = "Admin123"


def get_active_users():
    url = f"{BASE_URL}/user"
    params = {
        "retired": "true",
        "v": "full",   # —Ä–æ–ª–∏ –∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ —Ç—É—Ç
        "limit": 100,
    }

    r = requests.get(
        url,
        params=params,
        auth=HTTPBasicAuth(USERNAME, PASSWORD),
        headers={"Accept": "application/json"},
        timeout=10,
    )

    if not r.ok:
        print("HTTP:", r.status_code)
        print("URL :", r.url)
        print("BODY:", (r.text or "")[:2000])
        r.raise_for_status()

    return r.json().get("results", [])


def extract_roles(user):
    roles = user.get("roles", [])
    return ", ".join(
        role.get("display", role.get("name", "-")) for role in roles
    ) or "-"


def extract_privileges(user):
    privileges = set()

    for role in user.get("roles", []):
        for priv in role.get("privileges", []):
            name = priv.get("display") or priv.get("name")
            if name:
                privileges.add(name)

    return ", ".join(sorted(privileges)) or "-"


def print_table(users):
    headers = ["Username", "Person", "Roles", "Privileges", "UUID", "Retired"]
    rows = []

    for user in users:
        person = user.get("person") or {}
        rows.append([
            user.get("username", "-"),
            person.get("display", "-"),
            extract_roles(user),
            extract_privileges(user),
            user.get("uuid", "-"),
            str(user.get("retired", "-")),
        ])

    col_widths = [
        max(len(str(row[i])) for row in ([headers] + rows))
        for i in range(len(headers))
    ]

    def format_row(row):
        return " | ".join(
            str(cell).ljust(col_widths[i]) for i, cell in enumerate(row)
        )

    separator = "-+-".join("-" * w for w in col_widths)

    print(f"\n–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: {len(rows)}\n")
    print(format_row(headers))
    print(separator)

    for row in rows:
        print(format_row(row))


if __name__ == "__main__":
    users = get_active_users()
    print_table(users)


====================================================================================================
MODULE: user.get_user_by_name
PATH:   user/get_user_by_name.py
====================================================================================================

import json
import requests
from requests.auth import HTTPBasicAuth

BASE_URL = "http://localhost/openmrs/ws/rest/v1"
API_USERNAME = "admin"
API_PASSWORD = "Admin123"

# üëá –ø—Ä–æ—Å—Ç–æ –º–µ–Ω—è–µ—à—å –∑–¥–µ—Å—å
TARGET_USERNAME = "doctor"


def get_user_by_username(username: str) -> dict:
    """
    GET /user/{username}?v=full
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    url = f"{BASE_URL}/user/{username}"
    params = {"v": "full"}

    r = requests.get(
        url,
        params=params,
        auth=HTTPBasicAuth(API_USERNAME, API_PASSWORD),
        headers={"Accept": "application/json"},
        timeout=15,
    )

    if r.status_code == 404:
        raise ValueError(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '{username}' –Ω–µ –Ω–∞–π–¥–µ–Ω")

    if not r.ok:
        print("HTTP:", r.status_code)
        print("URL :", r.url)
        print("BODY:", (r.text or "")[:4000])
        r.raise_for_status()

    return r.json()


if __name__ == "__main__":
    user_data = get_user_by_username(TARGET_USERNAME)

    # –∫—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥ –í–°–ï–ô –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    print(json.dumps(user_data, ensure_ascii=False, indent=2))


====================================================================================================
MODULE: user.get_user_by_uuid
PATH:   user/get_user_by_uuid.py
====================================================================================================

import json
import requests
from requests.auth import HTTPBasicAuth

BASE_URL = "http://localhost/openmrs/ws/rest/v1"
API_USERNAME = "admin"
API_PASSWORD = "Admin123"

# üëá –ø—Ä–æ—Å—Ç–æ –º–µ–Ω—è–µ—à—å –∑–¥–µ—Å—å
USER_UUID = "45ce6c2e-dd5a-11e6-9d9c-0242ac150002"


def get_user(user_uuid: str) -> dict:
    """
    GET /user/{uuid}?v=full
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–µ—Å—å JSON –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (full representation).
    """
    url = f"{BASE_URL}/user/{user_uuid}"
    params = {"v": "full"}

    r = requests.get(
        url,
        params=params,
        auth=HTTPBasicAuth(API_USERNAME, API_PASSWORD),
        headers={"Accept": "application/json"},
        timeout=15,
    )

    if not r.ok:
        print("HTTP:", r.status_code)
        print("URL :", r.url)
        print("BODY:", (r.text or "")[:4000])
        r.raise_for_status()

    return r.json()


if __name__ == "__main__":
    user_data = get_user(USER_UUID)

    # –∫—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥ –≤—Å–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞ user
    print(json.dumps(user_data, ensure_ascii=False, indent=2))


====================================================================================================
MODULE: user.get_user_with_add_patient
PATH:   user/get_user_with_add_patient.py
====================================================================================================

import requests
from requests.auth import HTTPBasicAuth

BASE_URL = "http://localhost/openmrs/ws/rest/v1"
USERNAME = "admin"
PASSWORD = "Admin123"

TARGET_PRIVILEGE = "Add Patients"
SHOW_ALL_PRIVILEGES = False


def get_json(url, *, params=None, timeout=10):
    r = requests.get(
        url,
        params=params,
        auth=HTTPBasicAuth(USERNAME, PASSWORD),
        headers={"Accept": "application/json"},
        timeout=timeout,
    )
    if not r.ok:
        print("HTTP:", r.status_code)
        print("URL :", r.url)
        print("BODY:", (r.text or "")[:2000])
        r.raise_for_status()
    return r.json()


def get_active_users(limit=100):
    url = f"{BASE_URL}/user"
    params = {"retired": "false", "v": "full", "limit": limit}
    return get_json(url, params=params).get("results", [])


def get_current_session_location_display() -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ª–æ–∫–∞—Ü–∏—é –¢–ï–ö–£–©–ï–ô —Å–µ—Å—Å–∏–∏ (—Ç–æ, —á—Ç–æ –≤—ã–±–∏—Ä–∞—é—Ç –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ –≤ RefApp),
    –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –º–æ–¥—É–ª—å appui.
    """
    # –û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ: appui - —ç—Ç–æ –ù–ï –ø–æ–¥ BASE_URL (/ws/rest/v1), –Ω–æ –≤ —Ç–æ–º –∂–µ REST-–ø—Ä–µ—Ñ–∏–∫—Å–µ.
    url = BASE_URL.replace("/ws/rest/v1", "/ws/rest/v1/appui/session")
    data = get_json(url, params={"v": "full"})

    # –û–±—ã—á–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç 'sessionLocation' (–æ–±—ä–µ–∫—Ç location) –∏–ª–∏ –ø–æ—Ö–æ–∂–µ–µ –ø–æ–ª–µ.
    loc = data.get("sessionLocation") or data.get("location") or {}
    if isinstance(loc, dict):
        return loc.get("display") or loc.get("name") or loc.get("uuid") or "-"
    return str(loc) if loc else "-"


def role_name(role: dict) -> str:
    return role.get("display") or role.get("name") or "-"


def privilege_name(priv: dict) -> str:
    return priv.get("display") or priv.get("name") or ""


def extract_roles(user: dict) -> str:
    return ", ".join(role_name(r) for r in user.get("roles", [])) or "-"


def extract_privileges_set(user: dict) -> set[str]:
    privs = set()
    for role in user.get("roles", []):
        for priv in role.get("privileges", []):
            name = privilege_name(priv)
            if name:
                privs.add(name)
    return privs


def roles_granting_privilege(user: dict, target_priv: str) -> str:
    granting = []
    for role in user.get("roles", []):
        role_privs = {privilege_name(p) for p in role.get("privileges", []) if privilege_name(p)}
        if target_priv in role_privs:
            granting.append(role_name(role))
    return ", ".join(granting) or "-"


def has_privilege(user: dict, target_priv: str) -> bool:
    return target_priv in extract_privileges_set(user)


def filter_users_with_privilege(users: list[dict], target_priv: str) -> list[dict]:
    return [u for u in users if has_privilege(u, target_priv)]


def print_table(users: list[dict], target_priv: str, session_location: str):
    if SHOW_ALL_PRIVILEGES:
        headers = ["Username", "Person", "Roles", "Granting roles", "Privileges", "User UUID"]
    else:
        headers = ["Username", "Person", "Roles", "Granting roles", "Priv count", "User UUID"]

    rows = []
    for user in users:
        person = user.get("person") or {}
        privs = sorted(extract_privileges_set(user))
        granting = roles_granting_privilege(user, target_priv)

        rows.append([
            user.get("username", "-"),
            person.get("display", "-"),
            extract_roles(user),
            granting,
            ", ".join(privs) if SHOW_ALL_PRIVILEGES else str(len(privs)),
            user.get("uuid", "-"),
        ])

    print(f"\nSession Location (–¥–ª—è —Ç–µ–∫—É—â–∏—Ö –∫—Ä–µ–¥–æ–≤): {session_location}\n")

    if not rows:
        print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–∏–≤–∏–ª–µ–≥–∏–µ–π '{target_priv}' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.\n")
        return

    col_widths = [max(len(str(row[i])) for row in ([headers] + rows)) for i in range(len(headers))]

    def format_row(row):
        return " | ".join(str(cell).ljust(col_widths[i]) for i, cell in enumerate(row))

    separator = "-+-".join("-" * w for w in col_widths)

    print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –ø—Ä–∏–≤–∏–ª–µ–≥–∏–µ–π '{target_priv}': {len(rows)}\n")
    print(format_row(headers))
    print(separator)
    for row in rows:
        print(format_row(row))


if __name__ == "__main__":
    session_loc = "-"
    try:
        session_loc = get_current_session_location_display()
    except requests.HTTPError:
        # –µ—Å–ª–∏ appui –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ –∑–∞–ø—Ä–µ—â—ë–Ω –¥–æ—Å—Ç—É–ø ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∂–µ–º "-"
        session_loc = "-"

    users = get_active_users(limit=100)
    filtered = filter_users_with_privilege(users, TARGET_PRIVILEGE)
    print_table(filtered, TARGET_PRIVILEGE, session_loc)


====================================================================================================
MODULE: user.get_user_without_add_patient
PATH:   user/get_user_without_add_patient.py
====================================================================================================

import requests
from requests.auth import HTTPBasicAuth

BASE_URL = "http://localhost/openmrs/ws/rest/v1"
USERNAME = "admin"
PASSWORD = "Admin123"

MISSING_PRIVILEGE = "Add Users"
SHOW_ALL_PRIVILEGES = False


def get_active_users(limit=100):
    url = f"{BASE_URL}/user"
    params = {
        "retired": "false",
        "v": "full",
        "limit": limit,
    }

    r = requests.get(
        url,
        params=params,
        auth=HTTPBasicAuth(USERNAME, PASSWORD),
        headers={"Accept": "application/json"},
        timeout=10,
    )

    if not r.ok:
        print("HTTP:", r.status_code)
        print("URL :", r.url)
        print("BODY:", (r.text or "")[:2000])
        r.raise_for_status()

    return r.json().get("results", [])


def role_name(role: dict) -> str:
    return role.get("display") or role.get("name") or "-"


def privilege_name(priv: dict) -> str:
    return priv.get("display") or priv.get("name") or ""


def extract_roles(user: dict) -> str:
    return ", ".join(role_name(r) for r in user.get("roles", [])) or "-"


def extract_privileges_set(user: dict) -> set[str]:
    privs = set()
    for role in user.get("roles", []):
        for priv in role.get("privileges", []):
            name = privilege_name(priv)
            if name:
                privs.add(name)
    return privs


def roles_granting_privilege(user: dict, target_priv: str) -> str:
    granting = []
    for role in user.get("roles", []):
        role_privs = {privilege_name(p) for p in role.get("privileges", []) if privilege_name(p)}
        if target_priv in role_privs:
            granting.append(role_name(role))
    return ", ".join(granting) or "-"


def lacks_privilege(user: dict, missing_priv: str) -> bool:
    return missing_priv not in extract_privileges_set(user)


def filter_users_without_privilege(users: list[dict], missing_priv: str) -> list[dict]:
    return [u for u in users if lacks_privilege(u, missing_priv)]


def print_table(users: list[dict], missing_priv: str):
    if SHOW_ALL_PRIVILEGES:
        headers = ["Username", "Person", "Roles", "Has privilege via roles", "Privileges", "User UUID"]
    else:
        headers = ["Username", "Person", "Roles", "Has privilege via roles", "Priv count", "User UUID"]

    rows = []
    for user in users:
        person = user.get("person") or {}
        privs = sorted(extract_privileges_set(user))
        granting = roles_granting_privilege(user, missing_priv)

        rows.append([
            user.get("username", "-"),
            person.get("display", "-"),
            extract_roles(user),
            granting if granting != "-" else "‚ùå none",
            ", ".join(privs) if SHOW_ALL_PRIVILEGES else str(len(privs)),
            user.get("uuid", "-"),   # ‚Üê –Ø–í–ù–û user UUID
        ])

    if not rows:
        print(f"\n–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–º–µ—é—Ç –ø—Ä–∏–≤–∏–ª–µ–≥–∏—é '{missing_priv}'.\n")
        return

    col_widths = [
        max(len(str(row[i])) for row in ([headers] + rows))
        for i in range(len(headers))
    ]

    def format_row(row):
        return " | ".join(str(cell).ljust(col_widths[i]) for i, cell in enumerate(row))

    separator = "-+-".join("-" * w for w in col_widths)

    print(f"\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ë–ï–ó –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ '{missing_priv}': {len(rows)}\n")
    print(format_row(headers))
    print(separator)
    for row in rows:
        print(format_row(row))


if __name__ == "__main__":
    users = get_active_users(limit=100)
    filtered = filter_users_without_privilege(users, MISSING_PRIVILEGE)
    print_table(filtered, MISSING_PRIVILEGE)


====================================================================================================
MODULE: user.make_user_retired
PATH:   user/make_user_retired.py
====================================================================================================

import requests

BASE_URL = "http://localhost/openmrs/ws/rest/v1"
AUTH = ("admin", "Admin123")

USERNAME_TO_RETIRE = "user224"
user_uuid = '288cd575-1134-46d5-aa1b-2e11d79ca13f'
REASON = "No longer active"
#user224  | Demo224 User | Privilege Level: Full | Privilege Level: Full | 288cd575-1134-46d5-aa1b-2e11d79ca13f | False

# –Ω–∞–π—Ç–∏ uuid –ø–æ username
r = requests.get(f"{BASE_URL}/user", auth=AUTH, params={"q": USERNAME_TO_RETIRE})
r.raise_for_status()
results = r.json().get("results", [])
if not results:
    raise RuntimeError(f"User '{USERNAME_TO_RETIRE}' not found")
user_uuid = results[0]["uuid"]

print("uuid:", user_uuid)

# retire —á–µ—Ä–µ–∑ DELETE + reason
r = requests.delete(
    f"{BASE_URL}/user/{user_uuid}",
    auth=AUTH,
    params={"reason": REASON},
    headers={"Accept": "application/json"},
)

print("status:", r.status_code)
print(r.text)
r.raise_for_status()

